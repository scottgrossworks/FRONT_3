<!-- 
    -- HUSTLE 
    -- main UI for theLeedz.com
    --
    -->
   
   <!DOCTYPE html>
   <html lang="en">
   
   <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
        <title>the Leedz</title>
    
        
    <!-- Favicon -->
    <link rel="shortcut icon" type="image/png" href="/img/favicon.png"> 
    <link rel="icon" type="image/x-icon" href="/img/favicon.ico">


        <link rel="stylesheet" href="css/globals.css" type="text/css" />

        <link rel="stylesheet" href="css/user_panel.css" type="text/css" />        
        <link rel="stylesheet" href="css/dropdown.css" type="text/css" />
        <link rel="stylesheet" href="css/trades.css" type="text/css" />
        <link rel="stylesheet" href="css/calendar.css" type="text/css" />
        <link rel="stylesheet" href="css/month_chooser.css" type="text/css" />
        <link rel="stylesheet" href="css/distance_chooser.css" type="text/css" />
        <link rel="stylesheet" href="css/action_panel.css" type="text/css" />
        <link rel="stylesheet" href="css/welcome_panel.css" type="text/css" />
        <link rel="stylesheet" href="css/modal.css" type="text/css" />

        <link rel="stylesheet" href="css/styles_sm.css" type="text/css" />
        <link rel="stylesheet" href="css/styles_med.css" type="text/css" />
        <link rel="stylesheet" href="css/styles_lg.css" type="text/css" />


        
        <script src="./js/dbTools.js" type="module" defer></script>
        <script src="./js/badges.js" type="module" defer></script>
        <script src="./js/user.js" type="module" defer></script>
        <script src="./js/dates.js" type="module" defer></script>
        <script src="./js/trades.js" type="module" defer></script>
        <script src="./js/calendar.js" type="module" defer></script>
        <script src="./js/months.js" type="module" defer></script>
        <script src="./js/action.js" type="module" defer></script>
        <script src="./js/leed_edit.js" type="module" defer></script>
        <script src="./js/error.js" type="module" defer></script>


        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-PDE9MQDZ5V">
        </script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-PDE9MQDZ5V');
        </script>

  </head>  
   
  <body>
   





  <!--
  -- USER PANEL
  --
  --
  -->    

    <div class="row" id="user_panel">

      <div class="column _05" style="max-width:45px;"><button id="up_dot"></button></div>
      <div class="column _15" id="up_left_column"><label><a id="user_href" href="#"></a></label></div>
      
      
      <div class="column _65" id="up_center_column">

        <template id="template_badge">
          <div class="each_badge">
            <a href="#" class="badge_href"><img class="badge_img"></a>
          </div>
        </template>     

      </div>
      
      
      <div class="column _15 dropdown" id="up_right_column">
        
        <span id="up_addLeed"><a href="javascript:openCreateLeed();" title="Create Leed">+</a></span>
        
        <span id="up_logo"><a href="javascript:dropdownMenu();"><img src="./img/logo_dd.png"></a></span>
        <div id="dropdown_menu" class="dropdown-content">

          <a href="#" onclick="openUserEdit()" id="dd_account">Account</a>

          <a href="./leedz_how-to.html" id="dd_howto">How To</a>
          
          <a href="./leedz_about.html">About</a>

          <a href="./leedz_contact.html">Contact</a>


          <a id="dd_logout">Log Out</a>
        </div>
      </div>

      
    </div>


    <!-- SUCCESS ALERT -->
    <div id="alert_success" class="alert" style="display:none">
      <span class="closebtn" onclick="this.parentElement.style.display='none'">&times;</span>
    </div>




<!--
  --
  --
  --
  -->    
    <div class="row" id="main_panel">       
      


  <!-- 
    -- ERROR MODAL 
    -- 
    -->
    <div class="modal info_modal modal_noclose" id="error_modal" style="display:none">
      <center><img id="error_logo" src="img/logo_2.png"></center> 
      <h1>

      </h1>
      <a id="error_modal_close" href="javascript:modalClose(true);" href="">X</a>
      <BR>
      
    </div>
  
  

    <!-- 
      -- WAITING MODAL
      -- 
      -->
      <div class="modal info_modal" id="waiting_modal" style="display:none">

      <center><img class="info_logo" src="img/logo_2.png" style="padding-bottom:0"></center> 
        <table width="100%">
            <TR><TD style="border:none;">
              <h1 id="waiting_label" style="width:fit-content"></h1>
            </TD></TR>
            <TR><TD style="border:none;"><center>
                    <img src="./img/wait_spinner.gif" style="height:10vh;width:10vh">
                    </center>
                </TD>
            </TR>
        </table>

  
      </div>
    
    
    
        
    
      <!-- 
        -- NEW USER WELCOME MODAL 
        -- 
        -->
        <div class="modal info_modal modal_noclose" id="newUser_modal" style="display:none">
    
          <center><img class="info_logo" src="img/logo_2.png"></center> 
          <h1>
              <center>
              <table>
                <TR><TD><center><B style="font-size:x-large">Welcome to The Leedz!</B></center>
                  <BR>
                    To get the most out of <b style='color:green'>The Leedz</b>, complete your <a href="#" onclick="openUserEdit()">User Info</a> and introduce yourself to buyers.  
                    <a href="#" onclick="openUserEdit()">Authorize Square</a> to send and receive payments.  
                    Then <a href="#" onclick="openUserEdit()">subscribe to trades</a> and view the current leedz posted on the calendar.  
                    Choose a trade, <a href="./leedz_how-to.html">post a leed</a>, and start selling!
                  <BR>
                  <BR>
                    <ul type="2" style="margin-left:3vw">
                      <li><a onclick="openUserEdit()">Edit User Info</a></li>
                      <li><a href="./leedz_how-to.html">How-To Buy &amp; Sell</a></li>
                      <li><a href="./leedz_about.html">About the Leedz</a></li>
                      <li><a href="./leedz_contact.html">Contact Us</a></li>
                    </ul>
                     </TD></TR>
              </table>
              </center> 
            </h1>
            <a class="info_modal_close" href="javascript:modalClose(true);" href="">X</a>
            <BR>
        </div>
    
      






      <!-- 
        -- LEFT COLUMN
        -- TRADES PANEL 
        -->
      <div id="trades_column" class="column _15">
          
          
        
        <!-- OPEN SIDEBAR BUTTON -->
        <button id="open_side_btn" class="openbtn" onclick="javascript:openClose()"></button>


        <!-- all of the trades code -->
        <div id="side_panel" class="trades_side">


          <BR>

                    <!-- distance radius chooser -->
        <div id="distance_chooser">
          <form id="distance_form">
            <input id="distance_miles" type="text" title="Miles"> Miles From
            <input id="distance_from" type="text" title="From Zip"> Zip Code
            <input type="button" value="Find Leedz" id="distance_button" onclick="findLeedz()">
          </form>

        </div>

        
        <P style="height:16px"></P>

            <div class="trades" >
              <ul id="trades_list">
          
          
                <template id="template_each_trade">
                  <li class="each_trade">
                    <input type="checkbox" class="trade_checkbox" />
                    <button class="trade_radio"></button>
                    <label></label><sup></sup>
                  </li>
                </template>          

              </ul>



              <button class="add_button" id="add_trade" onclick='javascript:openUserEdit();'><img src="./img/plus.png"><b>Trade</b></button>
              <button class="add_button" id="post_leed" onclick='javascript:openCreateLeed();'><img src="./img/plus.png"><b>Leed</b></button>
            </div>

            <BR>

       
   


          </div>  

        
        </div>      


       
      <!-- CENTER COLUMN  -->      
      <div id="calendar_main" class="column _5">

           <!-- MONTH CHOOSER --> 
        <div id="months" class="row month_chooser">
          
          <div class="column _1" id="month-left"></div>
          <div class="column _7"><span id="month_label"></span></div>
          <div class="column _1" id="month-right"></div>

        </div>
    
        <!-- CALENDAR PANEL -->
        <div id="calendar_panel" class="row calendar">
            <ul id="calendar_list">

              <template id="template_each_day">
                <li class="each_day">
                  <div class="dateSquare"><span></span></div>                
                </li>
              </template>          
            
            </ul>


          <div class="leed_thumbnail"></div>
        </div>
        
      </div>
        





      <!-- RIGHT COLUMN
        -- WELCOME PANEL / ACTION PANEL 
        -->
      <div id="welcome_panel" class="column _35">
        <div class="row">
          <span>
            <img id="welcome_logo" src="./img/logo_2.png">
          </span>
        </div>
          
        <div class="row">
          <div id="welcome_tag">Buy. Sell. Grow your hustle.</div>
        </div>

        
        <div class="row">
          <button class="button welcomeButton" onclick="window.open('./leedz_how-to.html', '_self')">How It Works</button>
       
        </div>      

        <div class="row">
          <button class="button welcomeButton" onclick="window.open('./leedz_contact.html', '_self')">Contact Us</button>
       
        </div>      

        </div>





      <div id="action_panel" style="display:none;" class="column _35">



        <div class="leed_info_container">




          <div class="row lic_row" id="leed_title">
            
            <div class="column lic_column"  id="lic_color">
                <button id="lic_trade_radio" class="trade_radio"></button>
            </div>

            <div class="column lic_column" id="lic_trade"></div>

            
            <div class="column lic_column" id="lic_date"></div>
            
            <div class="column _1 lic_column" id="lic_close">
              <a id="" href="javascript:modalClose(true);">X</a>
            </div>

          </div>




          <div class="row lic_row" id="title">
            <div class="column lic_column _25 label" id="title_label">Event</div>
            <div class="column lic_column _75" id="title_value"></div>
          </div>



          <div class="row lic_row" id="start-end">
            <div class="column lic_column _25 label" id="start-end_label">Time</div>
            <div class="column lic_column _75" id="start-end_value"></div>
          </div>


          

          <div class="row lic_row" id="loc">
            <div class="column lic_column _25 label" id="loc_label">Address</div>
            <div class="column lic_column _75" id="loc_value"></div>
          </div>
      

          
          <div class="row lic_row" id="zip">
            <div class="column lic_column _25 label" id="zip_label">Zip</div>
            <div class="column lic_column _75" id="zip_value"></div>
          </div>




          <div class="row lic_row" id="em">
            <div class="column lic_column _25 label" id="em_label">Email</div>
            <div class="column lic_column _75" id="em_value"></div>
          </div>
                    


          <div class="row lic_row" id="ph">
            <div class="column lic_column _25 label" id="ph_label">Phone</div>
            <div class="column lic_column _75" id="ph_value"></div>
          </div>
                    



          <div class="row lic_row" id="det">
            <div class="column lic_column _25 label" id="det_label">Details</div>
            <div class="column lic_column _75" id="det_value"></div>
          </div>


          <div class="row lic_row" id="reqs">
            <div class="column lic_column _25 label" id="reqs_label">Requires</div>
            <div class="column lic_column _75" id="reqs_value"></div>
          </div>


          <div class="row lic_row" id="creator">
            <div class="column lic_column _25 label" id="creator_label">Posted By</div>
            <div class="column lic_column _75" id="creator_value"></div>
          </div>
          

          
          <div class="row lic_row" id="pr">
            <div class="column lic_column _25 label" id="pr_label">Price</div>
            <div class="column lic_column _75" id="pr_value"></div>
          </div>


        </div>

        <!--
          --  ACTION BUTTONS 
          --
          --  1/2024 added Square Payment link to Buy button sq_url
        -->
        <!-- BUY BUTTON -->
        <div class="row" id="row_buy_button">
          <button id="action_buy" class="button buy_button"  onclick="buyButton()">Buy<img id="shopping_cart" src="img/shopping-cart.png"></button>
        </div>

        <div class="row" id="row_report_button">
          <button id="action_report" class="button report_button" onclick="reportLeed()">Report</button>
        </div>
    

        <div class="row" id="row_edit_button">
          <button id="action_edit" class="button edit_button" onclick="openLeedEdit()">Edit&nbsp;<img id="edit_icon" src="img/edit.png"></button>
        </div>

        <div class="row" id="row_del_button">
          <button id="action_del" class="button del_button" onclick="deleteLeed()">Delete&nbsp;</button>
        </div>

        <div class="row" id="spacer" style="height:20vh"><BR><BR></div>
      </div>


      
    </div>

    


  </body>


  <script type="module" charset=”utf-8″>

    import { initUser, getUserLogin, guestUser, getCurrentUser, saveUserChanges, buySellReady, isGuestUser, isSubscribed } from "./js/user.js";      
    import { initTrades } from "./js/trades.js";   
    import { buildCalendar, loadCacheLeedz, loadDBLeedz } from "./js/calendar.js";
    import { initMonthChooser } from "./js/months.js";
    import { getCurrentLeed, clearCurrentLeed, buyCurrentLeed, deleteCurrentLeed, reportCurrentLeed  }  from "./js/leed.js";
    import { printError, throwError, errorModal, modalClose, errorModalClose } from "./js/error.js";
 
    import { waitCursor, normalCursor, showWaitingModal, leed_edit_Delete, goodValue } from "./js/leed_edit.js";
        

    import { USERNAME_URL_PARAM, DB_FAIL, DB_SUCCESS } from "./js/dbTools.js";


    const BUG_EMAIL = "<a href='mailto:scottgrossworks@gmail.com'>Report Error</a>"
    window.printError = printError;
    window.errorModalClose = errorModalClose;
      
    const URL_LOGIN = "https://theleedz.auth.us-west-2.amazoncognito.com/login?client_id=12tgt6nf496i446dq70gaoohrj&response_type=token&scope=email+openid&redirect_uri=https%3A%2F%2Ftheleedz.com/hustle.html";

    const URL_STATS_PAGE = "http://theleedz.com";
    const URL_LEED_REPORT = "./leed_report.html";
    const URL_LEED_BOUGHT = "./leed_bought.html";
    const URL_LEED_CREATE = "./leed_creator.html";
    const URL_LEED_EDIT = "./leed_editor.html";
          
    const URL_USER_EDIT = "./user_editor.html";



      /** 
      * Set the width of the sidebar to 250px (show it)
      *
      *
      */

      export function openClose() {
          
          if (SIDE_OPEN) {
              closeNav();
          } else {
              openNav();
          }
      }
      window.openClose = openClose;





       /**
         * DROP DOWN MENU
         */
         let DROP_DOWN = false;

         /* When the user clicks on the button,
         toggle between hiding and showing the dropdown content */
         export function dropdownMenu() {

          if (isGuestUser( true )) {  

            // ACCOUNT DROPDOWN
            //
            var ddAccount = document.getElementById("dd_account");
            ddAccount.style.opacity = 0.5;
            ddAccount.setAttribute("onclick", "printError('openUserEdit', 'Cannot edit Guest user account')");


            // LOGIN / LOGOUT DROPDOWN
            var ddLogout = document.getElementById("dd_logout");
            ddLogout.style.opacity = 1;
            ddLogout.setAttribute("onclick", "window.open('" + URL_LOGIN + "', '_self')");
            ddLogout.innerHTML = "Log In";

          } else {
            
            // LOGOUT
            // send them back to stats page
            //
            var ddLogout = document.getElementById("dd_logout");
            ddLogout.style.opacity = 0.5;
            ddLogout.setAttribute("onclick", "window.open('" + URL_STATS_PAGE + "', '_self')");
            ddLogout.innerHTML = "Log Out";
          }



          const menu = document.getElementById("dropdown_menu");
          menu.classList.toggle("show");

           DROP_DOWN ^= 1; // flip flag
         }
         window.dropdownMenu = dropdownMenu;
         





          //
          // ANY window click registers here
          //
          window.addEventListener( "click", (event) => {

       
            if ( event.target.id.endsWith("modal_close") ) {
              // modal dialog close 
              modalClose( true );

            } else if (event.target.matches('a')) {
              
              // event.target will be http link
              window.open( event.target , "_self");
            


            } else if (! (event.target.matches('img'))) {
              
              // click -- not on a link and not on the dropdown image
              // Close the dropdown menu if the user clicks outside of it
        
              var dropdown = document.getElementById("dropdown_menu");
              dropdown.classList.remove("show");

            }
           

          }, true);

          
      




      //  
      //  DISTANCE CHOOSER
      //
      // search for leedz using distance chooser 'Find Leedz' dialog and current trades subscribed
      // 
      //
      // <div id="distance_chooser">
      // <form id="distance_form">
      //   <input id="distance_miles" type="text" title="Miles"> Miles From
      //   <input id="distance_from" type="text" title="From Zip"> Zip Code
      //   <input type="button" value="Find Leedz" id="distance_button" onclick="findLeedz()">
      // </form>
      //
      function findLeedz() {

        try {

          waitCursor();

            let miles = document.getElementById("distance_miles");
            let zip = document.getElementById("distance_from");
            
            // verify that miles is a number <= 9999
            var trimVal = trimAndRemoveSpaces( miles.value );

            if ( trimVal ) {
                
                if (! isNumOnly( trimVal )) {
                  let errMsg = "Miles From must be a number";
                  printError("Miles contains non-numeric", errMsg );
                  
                  errorModal("Cannot search for Leedz<BR>" + errMsg, false);
                  return;
                }
                
                // SEARCH RADIUS
                const theMiles = new Number(trimVal);
                if (theMiles > 3000) {
                  let msg = "Miles From is too large: " + theMiles;
                  let errMsg = "Search radius must be < 3000 miles";
                  printError(msg, errMsg );

                  errorModal("Cannot search for Leedz<BR>" + msg + "<BR>" + errMsg, false);
                  return;
                }

                
                // verify that zip is a 5-digit number
                //
                trimVal = trimAndRemoveSpaces( zip.value );

                if (trimVal.length != 5) {
                    let errMsg = "Zip code must be 5 digits";
                    printError("Zip Code length", errMsg );
                    
                    errorModal("Cannot search for Leedz<BR>" + errMsg, false);
                    return;
                }

                if (! isNumOnly( trimVal )) {

                    let msg = "Invalid Zip code: " + trimVal;
                    let errMsg = "Zip code must be all digits";
                    printError(msg, errMsg );
                    
                    errorModal("Cannot search for Leedz<BR>" + msg + "<BR>" + errMsg, false);
                    return;
                }

                // ZIP CODE
                const theZip = new Number(trimVal);
                
                // these values are inserted into the current user profile
                //
                CURRENT_USER.zr = theMiles.valueOf();
                CURRENT_USER.zp = theZip.valueOf();
              } else {

                CURRENT_USER.zr = null;
                CURRENT_USER.zp = 0;
              }
            
            // this is an async call
            // will return immediately - data shows up later        
            saveUserChanges( CURRENT_USER );

            // this is an async call
            // will return immediately - data shows up later
            loadDBLeedz();
          
          
          } finally {
            normalCursor();
          }

      }
      window.findLeedz = findLeedz;






/**
 * returns true if the str represents a number
 *  
 */
 function isNumOnly( str ) {

  // Defining the regular expression
  const strRegex = new RegExp(/^[0-9]+$/i);
       
  // match the regex with the string
  let result = strRegex.test( str );
  return result;
}




/**
 * will return null
 */
function trimAndRemoveSpaces(inputString) {

  if (! inputString) return null;

  if (inputString == "") return null;

  if (inputString == 'null') return null;

  // Trim leading/trailing white spaces and remove spaces in between
  let trimmedString = inputString.trim().replace(/\s+/g, " ");
  // Replace all single spaces with ""
  let resultString = trimmedString.replace(/ /g, "");

  return resultString;
}







      //
      // open NEW USER welcome modal
      // new account -- no subs / search
      //
      function openNewUserWelcome() {
        let newU = document.getElementById("newUser_modal");
        newU.style.display = "block";
      }
      window.openNewUserWelcome = openNewUserWelcome;







      

      // do NOT open leed create for guest account
      // do NOT open leed create if user is not authorized
      //
      function openCreateLeed() {

        if (buySellReady(false)) {
          printError("openCreateLeed", "Authorize Square to create leedz");
          openNewUserWelcome();
          return;
        } 
        // OPEN leed_creator.html
        window.open( URL_LEED_CREATE , "_self");
      }

      window.openCreateLeed = openCreateLeed;






      // do NOT open user edit page for guest account
      //
      //
      function openUserEdit() {

        if (isGuestUser( true )) {
          printError("openUserEdit", "Guest account cannot edit User Profile");
          openNewUserWelcome();
          return;
        }
        // OPEN user_editor.html
        window.open( URL_USER_EDIT , "_self");
      }

      window.openUserEdit = openUserEdit;



      



      
      //
      // open LEED edit page
      //
      //
      function openLeedEdit() {

        if (buySellReady( false )) {
          printError("openLeedEdit", "Authorize Square to edit leedz");
          openNewUserWelcome();
          return;
        }
          window.open( URL_LEED_EDIT , "_self");
        }
      window.openLeedEdit = openLeedEdit;




      //
      // REPORT a problem leed
      // showing in the action window
      // responsible for showing modal on error
      //
      async function reportLeed() {

        if (isGuestUser( true )) {
          printError("reportLeed", "Guest User cannot report leeds");
          openNewUserWelcome();
          return;
        }
        window.open( URL_LEED_REPORT , "_self");
      }
      window.reportLeed = reportLeed;




      /**
      * BUY BUTTON
      * 
      * STEP 1 -- LEEDZ API buyLeed() call
      * STEP 2 -- validate return data
      * STEP 3 -- open Square QuickPay Checkout Link
      * responsible for showing modal on error
      */
      async function buyButton() {

        if ( buySellReady ( false )) {
          printError("buyLeed", "Authorize Square to buy leedz");
          openNewUserWelcome();
          return;
        }


        const current_user = getCurrentUser(false);
        const current_leed = getCurrentLeed();

        /**
        ret_obj = {
          'id':id,
          'tn':tn,
          'sq_oid':sq_order_id,
          'sq_url':sq_long_url,
          'cd':1
        }
        *
        * 
        */
        let the_leed = null;
        try {

            waitCursor();
            showWaitingModal("Buying this leed . . .");

          // STEP 1 -- buyLeed() AWS lambda
          try {

                the_leed = await buyLeed();

                if (the_leed == null) {
                  throw new Error("Error buying current leed: null server response");
                }


            } catch (error) {
              
              // DO NOT FAIL -- show error modal dialog and print error to console
              var msg = "Cannot buy current leed.<BR>Please refresh page."
              msg = error.message + "<BR>" + msg;
              
              printError("Buy Leed", error);
              errorModal( msg , true );
              return;
              

            }


            // STEP 2 -- GOTO Square QuickCheckout Payment page
            //
            if (! the_leed['id'])
                throw new Error("Server did not return leed id");
    
            if (! the_leed['sq_url'])
              throw new Error("Server did not return Square payment url");

            // IS THE LEED WE CLICKED ON THE SAME AS THE ONE WE ARE SUPPOSED TO BE BUYING?!
            if (the_leed['id'] != current_leed.id)
              throw new Error("Leed being bought does not match leed requested: " + current_leed.id + " != " + the_leed['id'])

       
        } catch (error) {
          var msg = "Error buying leed: " + error.message;
          printError("Buy Leed", msg);
          errorModal(msg, true);
          return;


        } finally {
          normalCursor();
          modalClose(false);
        }


        // save to current_leed and wait for callback...
        current_leed.sq_oid = the_leed['sq_oid'];
        current_leed.sq_url = the_leed['sq_url'];
        
        let leed_desc = "[" + current_leed.tn + "] " + current_leed.ti + " (" + current_leed.id + ")";
        console.log("Buying Leed: " + leed_desc);
        console.log("Square order:" + current_leed.sq_oid);


        // STEP 2 -- send BUYER to Square hosted QuickCheckout page 
        // https://developer.squareup.com/reference/square/checkout-api/create-payment-link
        window.open( current_leed.sq_url, "_self"); 


      }
      window.buyButton = buyButton;


      

      /**
       * BUY LEED
       * 
       * STEP 1 -- buyLeed() function begins process
       * associate BUYER username with this Leed
       * GET BACK Square QuickPay Checkout Link and Square Order ID
       *
       */
      async function buyLeed() {
        

        let response = null;
        try {
            response = await buyCurrentLeed();

            if (! response) {
              throw new Error("Error buying current leed: null server response");
            }


        } catch (error) {
          
          // DO NOT FAIL -- show error modal dialog and print error to console
          var msg = "Cannot buy current leed.<BR>Please refresh page."
          msg = error.message + "<BR>" + msg;
          printError("Buy Leed", msg);
          throwError("buyCurrentLeed", error);
        }

        if (response.cd == 0) {
          var msg = "Error received from server: " + response.er;
          printError("Buy Leed", msg);
          throwError("Buy Leed", msg);
        }

        return response;
      }





      // DELETE the leed showing in the action window
      // responsible for showing modal on error
      //
      async function deleteLeed() {

          if ( buySellReady ( false )) {
            printError("deleteLeed", "Authorize Square to delete leedz");
            openNewUserWelcome();
            return;
          }

          waitCursor();

          try {
            const the_leed = await leed_edit_Delete();
            
            if (the_leed) {
              loadDBLeedz();
              showWelcomeColumn();
            }

          } finally {
            normalCursor();
          }

      }
      window.deleteLeed = deleteLeed;



        
      const col = document.getElementById("trades_column");      
      const side = document.getElementById("side_panel");
      const open = document.getElementById("open_side_btn");
      
      let SIDE_OPEN = true;
      let SCREEN_SIZE = 0; // 0, 1, 2 small

      
      


      function openNav() {

        side.style.width = "max-content";
   
        open.style.left = side.clientWidth + "px";
        open.innerHTML = "&#10140;"

        col.style.marginLeft = "0";
        
        SIDE_OPEN = true;
      }
 
      

      function closeNav() {

        side.style.width = "0";

        open.style.left = 0;
        open.innerHTML = "&#9776;"

        col.style.marginLeft = "-120px";

        SIDE_OPEN = false;
      }


      
        


      /**
       *
       */
      function cssScreenSize() {


        modalClose( false );

        let screen = getComputedStyle( document.documentElement ).getPropertyValue('--screen_size').trim();
        // console.log("SCREEN=" + screen);
        
          if (! screen) {
            
            if (document.clientWidth < 500) {
              screen = 'S';
            } else if (document.clientWidth < 950) {
              screen = 'M';
            } else {
              screen = 'L';
            }
        }


          var action = document.getElementById("action_panel");


          if (screen == 'L') {

            action.setAttribute("screen", 2);  
            openNav();
            showWelcomeColumn();


          } else if (screen == 'M') {

            action.setAttribute("screen", 1);
            closeNav();
            actionModal( true );


          } else {

            action.setAttribute("screen", 0);
            closeNav();  
            actionModal( true );

          }
      }


      window.cssScreenSize = cssScreenSize;

      
/**
 * SHOW Right-hand WELCOME column
 */
      function showWelcomeColumn() {

        let action = document.getElementById("action_panel");
        action.style.display = "none";

        let welcome = document.getElementById("welcome_panel");

        welcome.classList.replace("modal", "column");
        welcome.style.display = "flex";
        
        // let closeBut = document.getElementById("buy_modal_close");
        // closeBut.style.display = "none";
      }
      window.showWelcomeColumn = showWelcomeColumn;




/**
 * HIDE WELCOME column
 * SHOW Right-hand ACTION modal
 *
 */
  function actionModal( show ) {

    //
    // SHOW
    //
    if (show) {
      let welcome = document.getElementById("welcome_panel");
      welcome.style.display = "none";

      var closeColumn = document.getElementById("lic_close");
      closeColumn.style.display = "flex";

      // let closeBut = document.getElementById("buy_modal_close");
      // closeBut.style.display = "flex";

      let action = document.getElementById("action_panel");
      action.className = "modal";

      //
      // HIDE
      //
    } else {
      
      let action = document.getElementById("action_panel");
      action.style.display = "none";
    }

  }
  window.actionModal = actionModal;







      


  /**
    * USER
    *
    */
function initUserPanel(current_user) {

    // UPDATE the UI with the current user info
    // depending on guestUser/Square status

    let dot = document.getElementById("up_dot");
    let user_href = document.getElementById("user_href");

  
    if (isGuestUser(true)) {
      dot.style.backgroundColor = "darkorange";
      user_href.style.color = "darkorange";

      dot.addEventListener( "click", (event) => {    
        openNewUserWelcome();
      });

      user_href.addEventListener( "click", (event) => {    
        openNewUserWelcome();
      });
    
      return;
    }

    if (buySellReady(true)) {
        dot.style.backgroundColor = "var(--LEEDZ_GREEN)";
    } else {
        // indicate user still needs to register Square
        dot.style.backgroundColor = "dodgerblue";
    }

    // user_href.style.color = "var(--LEEDZ_GREEN)";

    // OPEN THE USER EDITOR
    dot.addEventListener( "click", (event) => {    
      openUserEdit();
    });

    user_href.innerHTML = current_user.un;
    user_href.addEventListener( "click", (event) => {    
        openUserEdit();
    });

    showUserBadges(current_user);
      
}





/**
 * Show the user badges next to the profile name
 */
 function showUserBadges(current_user) {
    
    // start with a fresh list
    const theList = document.querySelector("#up_center_column");          

    while (theList.childElementCount > 1) {
      theList.removeChild( theList.lastElementChild );
    }

    if (current_user.bg.length == 0) return;

    // clone a new node
    //  <div class="each_badge">
    //    <a href="#" class="badge_href"><img class="badge_img"></a>
    //  </div>
    //  
    const theTemplate = document.querySelector("#template_badge");

    const total_badges = Object.keys( ALL_BADGES ).length;

    for (var i = 0; i < current_user.bg.length; i++) {

      if (i >= total_badges) break; // failsafe in case two are not in sync

      switch(i) {
        case 0:
          // badge 0 will either be the shield or Square icon
          if (current_user.sq_st == 'authorized') {
            addBadge( theList, theTemplate, current_user, "5");
          } else {
            addBadge( theList, theTemplate, current_user, "0");
          }
          break;

        case 5: // do not add the Square badge again
          break;

        default: // all other cases
          addBadge( theList, theTemplate, current_user, String(i))
          break;
      }
    }
  }

  
  //
  //
  //
  function addBadge( theList, theTemplate, current_user, badge_name) {

    var newNode = theTemplate.content.cloneNode(true).querySelector(".each_badge");

    var theImg = newNode.querySelector(".badge_img");
    theImg.src = "./img/badge_" + badge_name + ".png";

    var theHref = newNode.querySelector(".badge_href");
    theHref.setAttribute("href", "./leedz_about.html#badges");   
    theHref.setAttribute("title", ALL_BADGES[ badge_name ].tit);

    theList.appendChild(newNode);

  }






/**
 * LOAD and INITALIZE the UI
 *
 *
 */
async function mainPageLoad() {
    
      if (! CURRENT_USER ) CURRENT_USER = getCurrentUser(true);

      if ( buySellReady(true) ) {
        // console.log("main page load");
        showWaitingModal("Loading the Leedz . . .");      
      } else {
        openNewUserWelcome();
      }
      
      // clear any pre-existing leed in memory
      //
      clearCurrentLeed();


      // INIT USER PANEL
      //
      try {

        initUserPanel( CURRENT_USER );

      } catch (error) {
        var msg = "Cannot create user panel.<BR>Please refresh page."
        msg = error.message + "<BR>" + msg;

        printError("User Panel", error);
        errorModal( msg , true );
      }



      // INIT DISTANCE CHOOSER
      // using current_user preferences if set
      //
      try {
        
        let miles = document.getElementById("distance_miles");
        if (goodValue(CURRENT_USER.zr)) {
          miles.value = CURRENT_USER.zr;
        } else {
          miles.value = "";
        }

        let zip = document.getElementById("distance_from");
        if (goodValue(CURRENT_USER.zp)) {
          zip.value = CURRENT_USER.zp;
        } else {
          zip.value = "";
        }

      } catch (error) {

        var msg = "Cannot initialize distance chooser.<BR>Please refresh page."
        msg = error.message + "<BR>" + msg;

        printError("Distance Chooser", error);
        errorModal( msg , true );
      }



      /**
      * TRADES
      *
      * LOAD ALL trades and turn ON the ones subscribed to
      * when we turn ON a trade this will ALSO load the leedz
      * for each trade in current_user.sb[]
      */

      try {

        await initTrades();

      } catch (error) {

        // DO NOT FAIL -- show error modal dialog and print error to console
        var msg = "Cannot load trades.<BR>Please refresh page."
        msg = error.message + "<BR>" + msg;

        printError("Init Trades Column", error);
        errorModal( msg , true );
      }





    /**
    * INITIALIZE month chooser in middle column
    *
    */ 
      try {
  
        initMonthChooser();

      } catch (error) {
        var msg = "Cannot create month chooser.<BR>Please refresh page."
        msg = error.message + "<BR>" + msg;

        printError("Month Chooser", error);
        errorModal( msg , true );
      }



      /**
      * BUILD central calendar column 
      */
      try {

        buildCalendar();

      } catch (error) {

        var msg = "Cannot build calendar.<BR>Please refresh page."
        msg = error.message + "<BR>" + msg;

        printError("Building Calendar", error);
        errorModal( msg , true );
      }




      /**
      * If there are subs Load CACHE leedz
      */
    

      try {

        loadCacheLeedz();

      } catch (error) {

        var msg = "Cannot load leedz from cache.<BR>Please refresh page."
        msg = error.message + "<BR>" + msg;

        printError("Loading Cache Leedz", error);
        errorModal( msg , true );
      }

      /**
      * Load Leedz from DB -- will return immediately
      * delegate to callback internally when data arrives
      */

      try {
        loadDBLeedz();

      } catch (error) {

        var msg = "Cannot load leedz from DB.  <BR>Please refresh page."
        msg = error.message + "<BR>" + msg;

        printError("Loading DB Leedz", error);
        errorModal( msg , true );

      }
  

      /**
      * 
      */

      cssScreenSize();


      // set the trades sidebar      
      if (SIDE_OPEN) {
        openNav();
      } else {
        closeNav();
      }


  };




  /**
    * If we are coming here from a back button, refresh with the latest 
    * user data
    */
  let CURRENT_USER = null;
  
  addEventListener('pageshow', function(event) {

    actionModal( false );

    if (CURRENT_USER) { // are we coming BACK to this page?
      CURRENT_USER = getCurrentUser(true); // refresh and reload        

      if (isGuestUser(true)) {
        openNewUserWelcome();
      } else {
        showWaitingModal("Loading the Leedz . . .");
      } 

      mainPageLoad();
    }
  
  });




//
// ONLOAD
// START FROM HERE ON PAGE LOAD.....
//
//
// <body onload=" window.open(...)">

window.onload = async function() {

    const userLogin = {};

    try {

      getUserLogin( userLogin );
      // console.log(userLogin);

      if (! userLogin['un']) {
      // 
      // !! REDIRECT TO LOGIN URL
      //
      window.open(URL_LOGIN, "_self");
      return;
    }


    } catch (err) {
      var msg = "Cannot log into the Leedz.";
      msg = err.message + "<BR>" + msg + "<BR>Using guest account.";
      printError("Leedz Login", msg);
      errorModal( msg , true );

      // DO NOT FAIL
      // ! USE GUEST USER
      CURRENT_USER = guestUser();   
    }


    try {

      // re-initialize current user with login credentials from AWS  
      CURRENT_USER = await initUser( userLogin['un'] );

    } catch (error) {

      var msg = "Cannot load user data for " + userLogin['un'] + " [" + userLogin['em'] + "].<BR>Using guest account.";
      msg = error.message + "<BR>" + msg;
      printError("Leedz Login", msg);
      errorModal( msg , false );

      // DO NOT FAIL
      // ! USE GUEST USER
      CURRENT_USER = guestUser();   

    }
 
      // LOAD the page with the current user info
      mainPageLoad();

}
    
    


  /**
  * RESIZE
  * called on window resize -- but AFTER css applied -- can read values from 
  * different media_query css files depending on sizefvs
  */
  window.onresize = (event) => {
    cssScreenSize();
  };


  



</script>


</html>