<!-- 
    --
    --
    -->
   
   <!DOCTYPE html>
   <html lang="en">
   
   <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
        <title>Welcome to the Leedz</title>
    
        
    <!-- Favicon -->
    <link rel="shortcut icon" type="image/png" href="/img/favicon.png"> 
    <link rel="icon" type="image/x-icon" href="/img/favicon.ico">


        <link rel="stylesheet" href="css/globals.css" type="text/css" />

        <link rel="stylesheet" href="css/user_panel.css" type="text/css" />        
        <link rel="stylesheet" href="css/dropdown.css" type="text/css" />
        <link rel="stylesheet" href="css/trades.css" type="text/css" />
        <link rel="stylesheet" href="css/calendar.css" type="text/css" />
        <link rel="stylesheet" href="css/month_chooser.css" type="text/css" />
        <link rel="stylesheet" href="css/distance_chooser.css" type="text/css" />
        <link rel="stylesheet" href="css/action_panel.css" type="text/css" />
        <link rel="stylesheet" href="css/welcome_panel.css" type="text/css" />
        <link rel="stylesheet" href="css/modal.css" type="text/css" />

        <link rel="stylesheet" href="css/styles_sm.css" type="text/css" />
        <link rel="stylesheet" href="css/styles_med.css" type="text/css" />
        <link rel="stylesheet" href="css/styles_lg.css" type="text/css" />


        <script src="./js/dbTools.js" type="module" defer></script>

        <script src="./js/user.js" type="module" defer></script>
        <script src="./js/dates.js" type="module" defer></script>
        <script src="./js/trades.js" type="module" defer></script>
        <script src="./js/calendar.js" type="module" defer></script>
        <script src="./js/months.js" type="module" defer></script>
        <script src="./js/action.js" type="module" defer></script>
        <script src="./js/error.js" type="module" defer></script>

  </head>  
   
  <body>
   





  <!--
  -- USER PANEL
  --
  --
  -->    

    <div class="row" id="user_panel">

      <div class="column _05" style="max-width:45px;"><button id="up_dot"></button></div>
      <div class="column _15" id="up_left_column"><label><a id="user_href" href="#"></a></label></div>
      
      
      <div class="column _65" id="up_center_column">

        <template id="template_badge">
          <div class="each_badge">
            <a href="#" class="badge_href"><img class="badge_img"></a>
          </div>
        </template>     

      </div>
      
      
      <div class="column _15 dropdown" id="up_right_column">
        
        <span id="up_addLeed"><a href="javascript:openCreateLeed();" title="Create Leed">+</a></span>
        
        <span id="up_logo"><a href="javascript:dropdownMenu();"><img src="./img/logo_dd.png"></a></span>
        <div id="dropdown_menu" class="dropdown-content">

          <a href="#" onclick="openUserEdit()" id="dd_account">Account</a>

          <a href="./leedz_how-to.html" id="dd_howto">How To</a>
          
          <a href="./leedz_about.html">About</a>

          <a href="./leedz_contact.html">Contact</a>


          <a id="dd_logout">Log Out</a>
        </div>
      </div>

      
    </div>


    <div id="alert_success" class="alert" style="display:none">
      <span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
    </div>


<!--
  --
  --
  --
  -->    
    <div class="row" id="main_panel">       
      

      
      <!-- 
        -- LEFT COLUMN
        -- TRADES PANEL 
        -->
      <div id="trades_column" class="column _15">
          
          
        
        <!-- OPEN SIDEBAR BUTTON -->
        <button id="open_side_btn" class="openbtn" onclick="javascript:openClose()"></button>


        <!-- all of the trades code -->
        <div id="side_panel" class="trades_side">


          <BR>

                    <!-- distance radius chooser -->
        <div id="distance_chooser">
          <form id="distance_form">
            <input id="distance_miles" type="text" title="Miles"> Miles From
            <input id="distance_from" type="text" title="From Zip"> Zip Code
            <input type="button" value="Find Leedz" id="distance_button" onclick="findLeedz()">
          </form>

        </div>

        
        <P style="height:16px"></P>

            <div class="trades" >
              <ul id="trades_list">
          
          
                <template id="template_each_trade">
                  <li class="each_trade">
                    <input type="checkbox" class="trade_checkbox" />
                    <button class="trade_radio"></button>
                    <label></label><sup></sup>
                  </li>
                </template>          

              </ul>



              <button id="add_trade_button" onclick='javascript:openUserEdit();'><img src="./img/plus.png"><b>Trade</b></button>
 
            </div>

            <BR>

       
   


          </div>  

        
        </div>      


       
      <!-- CENTER COLUMN  -->      
      <div id="calendar_main" class="column _5">

           <!-- MONTH CHOOSER --> 
        <div id="months" class="row month_chooser">
          
          <div class="column _1" id="month-left"></div>
          <div class="column _7"><span id="month_label"></span></div>
          <div class="column _1" id="month-right"></div>

        </div>
    
        <!-- CALENDAR PANEL -->
        <div id="calendar_panel" class="row trades_calendar">
            <ul id="calendar_list">

              <template id="template_each_day">
                <li class="each_day">
                  <div class="dateSquare"><span></span></div>                
                </li>
              </template>          
            
            </ul>


          <div class="leed_thumbnail"></div>
        </div>
        
      </div>
        





      <!-- RIGHT COLUMN
        -- WELCOME PANEL / ACTION PANEL 
        -->
      <div id="welcome_panel" class="column _35">
        <div class="row">
          <span>
            <img id="welcome_logo" src="./img/logo_2.png">
          </span>
        </div>
          
        <div class="row">
          <div id="welcome_tag">Buy. Sell. Grow your hustle.</div>
        </div>

        
        <div class="row">
          <button class="button welcomeButton">How It Works</button>
       
        </div>      

        <div class="row">
          <button class="button welcomeButton">Contact Us</button>
       
        </div>      

        </div>





      <div id="action_panel" style="display:none;" class="column _35">



        <div class="leed_info_container">




          <div class="row lic_row" id="leed_title">
            
            <div class="column lic_column"  id="lic_color">
                <button id="lic_trade_radio" class="trade_radio"></button>
            </div>

            <div class="column lic_column" id="lic_trade"></div>

            
            <div class="column lic_column" id="lic_date"></div>
            
            <div class="column _1 lic_column" id="lic_close">
              <a id="" href="javascript:modalClose();">X</a>
            </div>

          </div>




          <div class="row lic_row" id="title">
            <div class="column lic_column _25 label" id="title_label">Event</div>
            <div class="column lic_column _75" id="title_value"></div>
          </div>



          <div class="row lic_row" id="start-end">
            <div class="column lic_column _25 label" id="start-end_label">Time</div>
            <div class="column lic_column _75" id="start-end_value"></div>
          </div>


          

          <div class="row lic_row" id="loc">
            <div class="column lic_column _25 label" id="loc_label">Address</div>
            <div class="column lic_column _75" id="loc_value"></div>
          </div>
      

          
          <div class="row lic_row" id="zip">
            <div class="column lic_column _25 label" id="zip_label">Zip</div>
            <div class="column lic_column _75" id="zip_value"></div>
          </div>




          <div class="row lic_row" id="em">
            <div class="column lic_column _25 label" id="em_label">Email</div>
            <div class="column lic_column _75" id="em_value"></div>
          </div>
                    


          <div class="row lic_row" id="ph">
            <div class="column lic_column _25 label" id="ph_label">Phone</div>
            <div class="column lic_column _75" id="ph_value"></div>
          </div>
                    



          <div class="row lic_row" id="det">
            <div class="column lic_column _25 label" id="det_label">Details</div>
            <div class="column lic_column _75" id="det_value"></div>
          </div>


          <div class="row lic_row" id="reqs">
            <div class="column lic_column _25 label" id="reqs_label">Requires</div>
            <div class="column lic_column _75" id="reqs_value"></div>
          </div>


          <div class="row lic_row" id="creator">
            <div class="column lic_column _25 label" id="creator_label">Posted By</div>
            <div class="column lic_column _75" id="creator_value"></div>
          </div>
          

          
          <div class="row lic_row" id="pr">
            <div class="column lic_column _25 label" id="pr_label">Price</div>
            <div class="column lic_column _75" id="pr_value"></div>
          </div>


        </div>

        <!--
          --
          --  ACTION BUTTONS 
          --
        -->

        <div class="row" id="row_buy_button">
          <button id="action_buy" class="button buy_button"  onclick="buyLeed()">Buy<img id="shopping_cart" src="img/shopping-cart.png"></button>
        </div>

        <div class="row" id="row_report_button">
          <button id="action_report" class="button report_button" onclick="reportLeed()">Report</button>
        </div>
    

        <div class="row" id="row_edit_button">
          <button id="action_edit" class="button edit_button" onclick="openLeedEdit()">Edit&nbsp;<img id="edit_icon" src="img/edit.png"></button>
        </div>

        <div class="row" id="row_del_button">
          <button id="action_del" class="button del_button" onclick="deleteLeed()">Delete&nbsp;</button>
        </div>

      </div>






      
    </div>







  <!-- 
    -- GUEST WELCOME MODAL 
    -- 
    -->
    <div class="row modal" id="guest_modal">
      <center><img id="guest_logo" src="img/logo_2.png"></center> 
      <h1>
          <center>
          <table>
            <TR><TD>
              Some features are not available to Guest users.
              <BR>
              <BR>
              To edit your user profile, buy, post, edit, or report a leed,
              <BR>
              <a href="http://scottgross.works">sign-up</a> for a <a href="http://scottgross.works">FREE</a> account.
            </TD></TR>
          </table>
          </center> 
        </h1>

          <BR>
      <a id="guest_modal_close" href="javascript:modalClose();" href="">X</a>
      <BR>
   
    </div>



    

  <!-- 
    -- NEW USER WELCOME MODAL 
    -- 
    -->
    <div class="row modal" id="newUser_modal">

      <center><img id="newUser_logo" src="img/logo_2.png"></center> 
      <h1>
          <center>
          <table>
            <TR><TD>
             To get the most out of the Leedz......
              <BR>
              <BR>
               Subscribe, set search radius....
               Contact Us
               Report a Leed
               <BR>
                 </TD></TR>
          </table>
          </center> 
        </h1>

          <BR>
      <a id="newUser_modal_close" href="javascript:modalClose();" href="">X</a>
      <BR>
   
    </div>



  <!-- 
    -- ERROR MODAL 
    -- 
    -->
  <div class="row" id="error_modal">
    <center><img id="error_logo" src="img/logo_2.png"></center> 
    <h1>
      <BR>
    </h1>
    <BR>
    <BR>
    <a id="error_modal_close" href="javascript:modalClose();" href="">X</a>
    
  </div>




  </body>


  <script type="module" charset=”utf-8″>

    import { initUser, guestUser, getCurrentUser, saveCurrentUser, isGuestUser, isSubscribed } from "./js/user.js";      
    import { initTrades } from "./js/trades.js";   
    import { buildCalendar, loadCacheLeedz, loadDBLeedz } from "./js/calendar.js";
    import { initMonthChooser } from "./js/months.js";
    import { getCurrentLeed, clearCurrentLeed, buyCurrentLeed, deleteCurrentLeed, reportCurrentLeed  }  from "./js/leed.js";
    import { CURRENT_LEED_KEY } from "./js/leed.js";
    import { showLeedAction } from "./js/action.js";
    import { ALL_BADGES } from "./js/badges.js";
    import { printError, throwError, errorModal, errorModalClose } from "./js/error.js";

    import { USERNAME_URL_PARAM, DB_FAIL, DB_SUCCESS } from "./js/dbTools.js";


    window.ALL_BADGES = ALL_BADGES;

    const BUG_EMAIL = "<a href='mailto:scottgrossworks@gmail.com'>Report Error</a>"
    window.printError = printError;
    window.errorModalClose = errorModalClose;
      
    const URL_LOGIN = "./index.html";

    const URL_LEED_BOUGHT = "./leed_bought.html";
    const URL_LEED_CREATE = "./leed_create.html";
    const URL_LEED_DELETED = "./leed_deleted.html";
    const URL_LEED_EDIT = "./leed_edit.html";
    const URL_LEED_REPORTED = "./leed_reported.html";
          
    const URL_USER_EDIT = "./user_edit.html";



      /** 
      * Set the width of the sidebar to 250px (show it)
      *
      *
      */

      export function openClose() {
          
          if (SIDE_OPEN) {
              closeNav();
              SIDE_OPEN = false;
          
          } else {
              openNav();
              SIDE_OPEN = true;
          }
      }
      window.openClose = openClose;





       /**
         * DROP DOWN MENU
         */
         let DROP_DOWN = false;

         /* When the user clicks on the button,
         toggle between hiding and showing the dropdown content */
         export function dropdownMenu() {

          if (isGuestUser( true )) {  

            // ACCOUNT DROPDOWN
            //
            var ddAccount = document.getElementById("dd_account");
            ddAccount.style.opacity = 0.5;
            ddAccount.setAttribute("onclick", "printError('openUserEdit', 'Cannot edit Guest user account')");


            // LOGIN / LOGOUT DROPDOWN
            // <a href="./index.html" id="dd_logout">Log Out</a>
            var ddLogout = document.getElementById("dd_logout");
            ddLogout.style.opacity = 1;
            ddLogout.setAttribute("onclick", "window.open('" + URL_LOGIN + "', '_self')");
            ddLogout.innerHTML = "Log In";

          } else {
            
            // <a href="./index.html" id="dd_logout">Log Out</a>
            var ddLogout = document.getElementById("dd_logout");
            ddLogout.style.opacity = 0.5;
            var the_url = "./index.html?" + USERNAME_URL_PARAM + "=guest.user";
            ddLogout.setAttribute("onclick", "window.open('" + the_url + "', '_self')");
            ddLogout.innerHTML = "Log Out";
          }



          const menu = document.getElementById("dropdown_menu");
          menu.classList.toggle("show");

           DROP_DOWN ^= 1; // flip flag
         }
         window.dropdownMenu = dropdownMenu;
         





          //
          // ANY window click registers here
          //
          window.addEventListener( "click", (event) => {

       
            if ( event.target.id.endsWith("modal_close") ) {
              // modal dialog close

            } else if (event.target.matches('a')) {
              
              // event.target will be http link
              window.open( event.target , "_self");
            


            } else if (! (event.target.matches('img'))) {
              
              // click -- not on a link and not on the dropdown image
              // Close the dropdown menu if the user clicks outside of it
        
              var dropdown = document.getElementById("dropdown_menu");
              dropdown.classList.remove("show");

            }
           

          }, true);

          
      




      //  
      //  DISTANCE CHOOSER
      //
      // search for leedz using distance chooser 'Find Leedz' dialog and current trades subscribed
      // 
      //
      // <div id="distance_chooser">
      // <form id="distance_form">
      //   <input id="distance_miles" type="text" title="Miles"> Miles From
      //   <input id="distance_from" type="text" title="From Zip"> Zip Code
      //   <input type="button" value="Find Leedz" id="distance_button" onclick="findLeedz()">
      // </form>
      //
      function findLeedz() {

        let miles = document.getElementById("distance_miles");
        let zip = document.getElementById("distance_from");
        
        // verify that miles is a number <= 9999
        var trimVal = trimAndRemoveSpaces( miles.value );
       
        if (! isNumOnly( trimVal )) {
          let errMsg = "Miles From must be a number";
          printError("Miles contains non-numeric", errMsg );
          
          errorModal("Cannot search for Leedz<BR>" + errMsg, false);
          return;
        }
        
        const theMiles = new Number(trimVal);
        if (theMiles > 9999) {
          let msg = "Miles From is too large: " + theMiles;
          let errMsg = "Search radius must be < 9999 miles";
          printError(msg, errMsg );

          errorModal("Cannot search for Leedz<BR>" + msg + "<BR>" + errMsg, false);
          return;
        }

        
        // verify that zip is a 5-digit number
        //
        trimVal = trimAndRemoveSpaces( zip.value );

        if (trimVal.length != 5) {
            let errMsg = "Zip code must be 5 digits";
            printError("Zip Code length", errMsg );
            
            errorModal("Cannot search for Leedz<BR>" + errMsg, false);
            return;
        }

        if (! isNumOnly( trimVal )) {

            let msg = "Invalid Zip code: " + trimVal;
            let errMsg = "Zip code must be all digits";
            printError(msg, errMsg );
            
            errorModal("Cannot search for Leedz<BR>" + msg + "<BR>" + errMsg, false);
            return;
        }

        const theZip = new Number(trimVal);
        
        // these values are inserted into the current user profile
        //
        const current_user = getCurrentUser(false);
        current_user.zr = theMiles.valueOf();
        current_user.zp = theZip.valueOf();
        

        // this is an async call
        // will return immediately - data shows up later
        loadDBLeedz();


        // this is an async call
        // will return immediately - data shows up later        
        saveCurrentUser();

      }
      window.findLeedz = findLeedz;






/**
 * returns true if the str represents a number
 *  
 */
 function isNumOnly( str ) {

  // Defining the regular expression
  const strRegex = new RegExp(/^[0-9]+$/i);
       
  // match the regex with the string
  let result = strRegex.test( str );
  return result;
}




function trimAndRemoveSpaces(inputString) {
  // Trim leading/trailing white spaces and remove spaces in between
  let trimmedString = inputString.trim().replace(/\s+/g, " ");
  // Replace all single spaces with ""
  let resultString = trimmedString.replace(/ /g, "");

  return resultString;
}





      //
      // open GUEST welcome modal
      // some features not available to guest accounts
      // invite user to sign up for account -- provide sign-up link
      //
      function openGuestWelcome() {
        let guest = document.getElementById("guest_modal");
        guest.style.display = "block";
      }
      window.openGuestWelcome = openGuestWelcome;




      //
      // open NEW USER welcome modal
      // new account -- no subs / search
      //
      function openNewUserWelcome() {
        let newU = document.getElementById("newUser_modal");
        newU.style.display = "block";
      }
      window.openNewUserWelcome = openNewUserWelcome;







      

      // do NOT open leed create for guest account
      //
      //
      function openCreateLeed() {


        if (isGuestUser( true )) {
          printError("openCreateLeed", "Guest user cannot create leedz");
          openGuestWelcome();

        } else {
          window.open( URL_LEED_CREATE , "_self");
        }
      }

      window.openCreateLeed = openCreateLeed;






      // do NOT open user edit page for guest account
      //
      //
      function openUserEdit() {

        if (isGuestUser( true )) {
          printError("openUserEdit", "Cannot edit Guest user account");
          openGuestWelcome();

        } else {
          window.open( URL_USER_EDIT , "_self");
        }
      }

      window.openUserEdit = openUserEdit;



      



      
      //
      // open LEED edit page
      //
      //
      function openLeedEdit() {

        // should NEVER happen
        if (isGuestUser( true )) {
          printError("openLeedEdit", "Guest User cannot edit leeds");
          openGuestWelcome();

        } else {

          window.open( URL_LEED_EDIT , "_self");
        }
      }
      window.openLeedEdit = openLeedEdit;




      //
      // REPORT a problem leed
      // showing in the action window
      // responsible for showing modal on error
      //
      async function reportLeed() {

        if (isGuestUser( true )) {
          printError("reportLeed", "Guest User cannot report leeds");
          openGuestWelcome();
          return;
        }


        let response = null;
        try {
            await reportCurrentLeed().then(( fromDB ) => response = fromDB );

            if (response == null) {
              throw new Error("Error reporting current leed: null server response");
            }


          } catch (error) {
            
            // DO NOT FAIL -- show error modal dialog and print error to console
            var msg = "Cannot report current leed.<BR>Please refresh page."
            msg = error.message + "<BR>" + msg;
            
            printError("Report Leed", error);
            errorModal( msg , true );
            return;
          }


        // GOTO report leed landing page
        // with link to get back to main page
        window.open( URL_LEED_REPORTED , "_self");


      }
      window.reportLeed = reportLeed;




      

      //
      // BUY current leed 
      // showing in the action window
      // responsible for showing modal on error
      //
      async function buyLeed() {
        
        if (isGuestUser( true )) {
          printError("buyLeed", "Guest User cannot buy leeds");
          openGuestWelcome();
          return;
        }
        

        let response = null;
        try {
            await buyCurrentLeed().then(( fromDB ) => response = fromDB );

            if (response == null) {
              throw new Error("Error reporting current leed: null server response");
            }


          } catch (error) {
            
            // DO NOT FAIL -- show error modal dialog and print error to console
            var msg = "Cannot buy current leed.<BR>Please refresh page."
            msg = error.message + "<BR>" + msg;
            
            printError("Buy Leed", error);
            errorModal( msg , true );
          }

          if (response.cd == 0) {
            var msg = "Error received from server: " + response.er;
            printError("Buy Leed", msg);
            errorModal(msg, true);
          }

          sessionStorage.setItem( CURRENT_LEED_KEY, response );

          // GOTO BUY leed landing page
          // with link to get back to main page
          window.open( URL_LEED_BOUGHT , "_self");


      }
      window.buyLeed = buyLeed;







      //
      // DELETE the leed showing in the action window
      // responsible for showing modal on error
      //
      async function deleteLeed() {


        if (isGuestUser( true )) {
          printError("deleteLeed", "Guest User cannot delete leeds");
          openGuestWelcome();
          return;
        }
        waitCursor();

        let from_DB = null;
        try {

            // GO BACK to server and delete leed
            // compliment of add leed

            from_DB = await deleteCurrentLeed();

        } catch ( error ) {
            printError("Delete Leed", error.message);
            errorModal("Error deleting leed: " + error.message, false);

        } finally {
            endEditing();
            normalCursor();
        }

        console.log("GOT RESULTS!!!");
        console.log(from_DB)


        /**
          * SHOW THE ERROR ALERT
          */
        if (fromDB == null || from_DB.er) {
          var msg = "Error deleting leed";
          if (fromDB) msg += (": " + from_DB.er);
          printError("Delete Leed", msg);
          errorModal(msg, false);


        } else {
          /**
            * SHOW THE SUCCESS ALERT
            *
            *  result = "{'id': " + id + ",'ti':" + ti + ",'pr':" + pr + ",'cd': 1}" 
            *            {'id': 15013540,'ti':2222 FairFax Airbrush Title,'pr':55,'cd': 1}
            */
            var theAlert = document.getElementById("alert_success");
            var msg = 'Deleted leed:  ' + from_DB.ti + '  ($ ' + from_DB.pr +' )';
            var newChild = document.createElement("span");
            newChild.textContent = msg;

            if (theAlert.children.length <= 1) {
                theAlert.appendChild(newChild);
            } else {
                theAlert.replaceChild(newChild, theAlert.children[1]);
            }

            theAlert.style.display = "block";
        }

      }
      window.deleteLeed = deleteLeed;



      
      const URL_BUY_LEED = "./leed_buy.html";
      const URL_REPORT_LEED = "./leed_reported.html";

        
      const col = document.getElementById("trades_column");      
      const side = document.getElementById("side_panel");
      const open = document.getElementById("open_side_btn");
      
      let SIDE_OPEN = true;
      let SCREEN_SIZE = 0; // 0, 1, 2 small

      
      


      function openNav() {

        side.style.width = "max-content";
   
        open.style.left = side.clientWidth + "px";
        open.innerHTML = "&#10140;"

        col.style.marginLeft = "0";
      }
 
      

      function closeNav() {

        side.style.width = "0";

        open.style.left = 0;
        open.innerHTML = "&#9776;"

        col.style.marginLeft = "-120px";
      }


      /**
       *
       */
      function cssScreenSize() {

        // errorModalClose();

        var screen = getComputedStyle( document.documentElement ).getPropertyValue('--screen_size').trim();
        var action = document.getElementById("action_panel");

        // console.log("%cCSS SCREEN SIZE=" + screen, "color:violet");

        switch (screen) {
  
          case "S":
            action.setAttribute("screen", 0);
            SIDE_OPEN = false;  
            actionModal();
            break;
          
          case "M":
            action.setAttribute("screen", 1);
            SIDE_OPEN = false;
            actionModal();
            break;
  
          case "L":

            action.setAttribute("screen", 2);
            modalClose();
            
            var closeColumn = document.getElementById("lic_close");
            closeColumn.style.display = "none";


            SIDE_OPEN = true;
            openNav();
            
            // 11/1
            // start with welcome screen always
            // to keep things consistent
            // Is there a current leed in cache
            /**
            let current_leed = getCurrentLeed();
            if (( current_leed.id != null ) && (isSubscribed( current_leed.tn ))) {
                    
                try {
                  showLeedAction(current_leed, false );

                } catch (error) {
                  printError("cssScreenSize", error);
                  errorModal("Cannot load leed details", error);
                  clearCurrentLeed();
                  welcomeColumn();
                }

            } else {
              clearCurrentLeed();
              welcomeColumn();
            }  
            */
            
            clearCurrentLeed();
            welcomeColumn();
            
            

            break;


            
  
          default:
            console.error("--screen_size not found");
            SIDE_OPEN = false;
            actionModal();
            break;
        }
      }


      
/**
 * Right-hand WELCOM column
 */
      function welcomeColumn() {

        let action = document.getElementById("action_panel");
        action.style.display = "none";

        let welcome = document.getElementById("welcome_panel");
        welcome.classList.replace("modal", "column");
        welcome.style.display = "flex";
        
        // let closeBut = document.getElementById("buy_modal_close");
        // closeBut.style.display = "none";
      }
      window.welcomeColumn = welcomeColumn;




/**
 * Right-hand ACTTION column
 */
      function actionModal() {
        let welcome = document.getElementById("welcome_panel");
        welcome.style.display = "none";

        var closeColumn = document.getElementById("lic_close");
        closeColumn.style.display = "flex";

        // let closeBut = document.getElementById("buy_modal_close");
        // closeBut.style.display = "flex";

        let action = document.getElementById("action_panel");
        action.className = "modal";
  
      }
      window.actionModal = actionModal;





/**
 * CLOSE (ANY) MODAL DIALOG
 */
      function modalClose() {


        let action = document.getElementById("action_panel");
        action.classList.remove("modal");
        action.classList.add("column");
        action.classList.add("_35");
        action.style.display = "none";

        // let closeBut = document.getElementById("buy_modal_close");
        // closeBut.style.display = "none";

        // close the guest modal
        // let modal = document.getElementById("guest_modal");
        // modal.style.display = "none";

        errorModalClose();

      }
      window.modalClose = modalClose;
    


      


  /**
    * USER
    *
    */
    function initUserPanel(current_user) {

      // whatever the current user identity -- continue ....
      // UPDATE the UI with the current user info
      // user clicks on username --> user edit account page

      let dot = document.getElementById("up_dot");
      dot.addEventListener( "click", (event) => {    
        openUserEdit();
      });
      
      let user_href = document.getElementById("user_href");
      user_href.innerHTML = current_user.un;
      // user_href.setAttribute("href", "#");
      user_href.addEventListener( "click", (event) => {    
          openUserEdit();
      });

      // force style the dot color in case of multiple login/refreshes
      dot.style.backgroundColor = "var(--LEEDZ_GREEN)";
      
      if (isGuestUser( true )) {
        user_href.style.color = "darkorange";
        dot.style.backgroundColor = "darkorange";
        //
        // FIXME FIXME FIXME
        // send guest.user to info/intro/sign-up page
        //
        user_href.setAttribute("href", "#");
        // user_href.addEventListener( "click", (event) => { });
        

      // BADGES
      } else if (current_user.bg.length != 0) {
          
          // clone a new node
          //
          //
          //  <div class="each_badge">
          //    <a href="#" class="badge_href"><img class="badge_img"></a>
          //  </div>
          //  
          const theList = document.querySelector("#up_center_column");
          const theTemplate = document.querySelector("#template_badge");
          
          for (var i = 0; i < current_user.bg.length; i++) {

            var the_badge = current_user.bg[i];

            var newNode = theTemplate.content.cloneNode(true).querySelector(".each_badge");

            var theImg = newNode.querySelector(".badge_img");
            theImg.src = "./img/badge_" + the_badge + ".png";

            var theHref = newNode.querySelector(".badge_href");
            theHref.setAttribute("href", "./leedz_about.html#badges");   // FIXME explain badge in About section #
            theHref.setAttribute("title", ALL_BADGES[ the_badge ].tit);

            theList.appendChild(newNode);
          } // for  

      }
  }












//////////////////////////////////////////////////////////////////////
//
// START FROM HERE ON PAGE LOAD.....
//
//////////////////////////////////////////////////////////////////////


          // full URL for index.html should include username parameter
          // index.html?un=scott.gross

          // IF WE COME HERE AFTER HOSTED LOGIN UI
          //   username will come from login sequence (hopefully)
          // IF WE COME HERE FROM BACK BUTTON ON user_edit page
          //   username will be passed in from account edit page
          
          // LOAD user profile data
          // LOAD list of subscribed trades
          // do not fail on error -- load Guest User as default
          //
        
          let current_user = null;

          const urlParams = new URLSearchParams(window.location.search);
          const url_username = urlParams.get( USERNAME_URL_PARAM );
          const alphaNum = /^[a-zA-Z0-9._-]+$/;

          //
          // validate the username param
          // must not be null
           if (url_username == null) {
            // use guest account
            printError("No username parameter", "Using Guest Account");
            
            // ! USE GUEST USER
            current_user = guestUser();


          //
          // must contain only alphanum chars
          } else if (! (alphaNum.test( url_username ))) {
            printError("Invalid username: " + url_username, "username can only contain alphanumeric chars");
            
            // ! USE GUEST USER
            current_user = guestUser();
      


          //
          // is this the guest user coming back from cache or another landing page
          //
          } else if (url_username == "guest.user") {

            current_user = guestUser();


      
          } else {

            try {
              await initUser( url_username ); // will throw error
  
              // return newly-loaded user
              current_user = getCurrentUser( false );


            } catch (error) {
  
              var msg = "Cannot load user data.<BR>Using guest account.";
              msg = error + "<BR>" + msg;
              errorModal( msg , false );
  
              // DO NOT FAIL
              // ! USE GUEST USER
              current_user = guestUser();   

            }

          }
          


          // INIT USER PANEL
          //
          try {

            initUserPanel( current_user );

          } catch (error) {
            var msg = "Cannot create user panel.<BR>Please refresh page."
            msg = error.message + "<BR>" + msg;
            
            printError("User Panel", error);
            errorModal( msg , true );
          }
          
    

          
          // INIT DISTANCE CHOOSER
          // using current_user preferences if set
          //
          try {
      
            let miles = document.getElementById("distance_miles");
            let zip = document.getElementById("distance_from");

            if (current_user.zr != null) miles.value = current_user.zr;
            if (current_user.zp != null) zip.value = current_user.zp;

          } catch (error) {
            var msg = "Cannot initialize distance chooser.<BR>Please refresh page."
            msg = error.message + "<BR>" + msg;
            
            printError("Distance Chooser", error);
            errorModal( msg , true );
          }
          
          
          var trade_subs = true;
          //
          // USER HAS NO TRADE SUBSCRIPTIONS!
          // no need to continue
          // open new user welcome with instructions
          if (current_user.sb.length == 0) {
              openNewUserWelcome();
              trade_subs = false;
          }
          
          
          
          // Do not load full UI if user has no trade subs
          //
        
          /**
           * TRADES
           *
           * LOAD ALL trades and turn ON the ones subscribed to
           * when we turn ON a trade this will ALSO load the leedz
           * for each trade in current_user.sb[]
           */
          
          if (trade_subs) {
            try {
            
              await initTrades();


            } catch (error) {
              
              // DO NOT FAIL -- show error modal dialog and print error to console
              var msg = "Cannot load trades.<BR>Please refresh page."
              msg = error.message + "<BR>" + msg;
              
              printError("Init Trades Column", error);
              errorModal( msg , true );
            }
          }


          

          /**
           * INITIALIZE month chooser in middle column
           *
           */ 
           try {
             initMonthChooser();
            
            } catch (error) {
              var msg = "Cannot create month chooser.<BR>Please refresh page."
              msg = error.message + "<BR>" + msg;
              
              printError("Month Chooser", error);
              errorModal( msg , true );
            }



          
          /**
           * BUILD central calendar column 
           */
           try {

              buildCalendar();

            } catch (error) {

              var msg = "Cannot build calendar.<BR>Please refresh page."
              msg = error.message + "<BR>" + msg;
              
              printError("Building Calendar", error);
              errorModal( msg , true );
            }




          /**
           * If there are subs Load CACHE leedz
           */
          if (trade_subs) {
            try {

              loadCacheLeedz();

            } catch (error) {

              var msg = "Cannot load leedz from cache.<BR>Please refresh page."
              msg = error.message + "<BR>" + msg;
              
              printError("Loading Cache Leedz", error);
              errorModal( msg , true );
            }
       
            /**
              * Load Leedz from DB -- will return immediately
              * delegate to callback internally when data arrives
            */

            try {

              loadDBLeedz();

            } catch (error) {

              var msg = "Cannot load leedz from DB.  <BR>Please refresh page."
              msg = error.message + "<BR>" + msg;
              
              printError("Loading DB Leedz", error);
              errorModal( msg , true );
            }
          }


          /**
          * 
          */

          cssScreenSize();


          // set the trades sidebar      
          if (SIDE_OPEN) {
            openNav();
          } else {
            closeNav();
          }


          /**
          * RESIZE
          * called on window resize -- but AFTER css applied -- can read values from 
          * different media_query css files depending on sizefvs
          */
          window.onresize = (event) => {
            cssScreenSize();
          };


     </script>
  
  
 
   
   
   
   </body>
  </html>