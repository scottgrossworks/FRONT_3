<!-- 
    --
    --
    -->
   
   <!DOCTYPE html>
   <html lang="en">
   
   <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
        <title>INDEX 3</title>
    
        
    <!-- Favicon -->
    <link rel="shortcut icon" type="image/png" href="/img/favicon.png"> 
    <link rel="icon" type="image/x-icon" href="/img/favicon.ico">


        <link rel="stylesheet" href="css/globals.css?v=1234" type="text/css" />

        <link rel="stylesheet" href="css/user_panel.css" type="text/css" />        
        <link rel="stylesheet" href="css/dropdown.css" type="text/css" />
        <link rel="stylesheet" href="css/trades.css" type="text/css" />
        <link rel="stylesheet" href="css/calendar.css" type="text/css" />
        <link rel="stylesheet" href="css/month_chooser.css" type="text/css" />
        <link rel="stylesheet" href="css/distance_chooser.css" type="text/css" />
        <link rel="stylesheet" href="css/action_panel.css" type="text/css" />
        <link rel="stylesheet" href="css/welcome_panel.css" type="text/css" />
        <link rel="stylesheet" href="css/modal.css" type="text/css" />

        <link rel="stylesheet" href="css/styles_sm.css" type="text/css" />
        <link rel="stylesheet" href="css/styles_med.css" type="text/css" />
        <link rel="stylesheet" href="css/styles_lg.css" type="text/css" />


        <script src="./js/dbTools.js" type="module" defer></script>

        <script src="./js/user.js" type="module" defer></script>
        <script src="./js/dates.js" type="module" defer></script>
        <script src="./js/trades.js" type="module" defer></script>
        <script src="./js/calendar.js" type="module" defer></script>
        <script src="./js/months.js" type="module" defer></script>
        <script src="./js/action.js" type="module" defer></script>
        <script src="./js/error.js" type="module" defer></script>

  </head>  
   
  <body>
   
    <div class="row" id="user_panel">

      <div class="column _20" id="up_left_column"><label><a id="user_href" href=""></a></label></div>
      <div class="column _7"></div>
      <div class="column _1 dropdown" id="up_right_column">
        
        <span id="up_addLeed"><a href="#add_leed" title="+ Sell Leed">+</a></span>
        
        <span id="up_logo"><a href="javascript:dropdownMenu();"><img src="./img/logo_wide.png"></a></span>
        <div id="dropdown_menu" class="dropdown-content">
          <a href="#" id="dd_account">Account</a>

          <a href="#" id="dd_howto">How To</a>
          <a href="#">About</a>

          <a href="#">Contact</a>


          <a href="#" id="dd_logout">Log Out</a>
        </div>
      </div>

      
    </div>




<!--
  --
  --
  --
  -->    
    <div class="row" id="main_panel">       
      

      
      <!-- 
        -- LEFT COLUMN
        -- TRADES PANEL 
        -->
      <div id="trades_column" class="column _15">
          
          
        
        <!-- OPEN SIDEBAR BUTTON -->
        <button id="open_side_btn" class="openbtn" onclick="javascript:openClose()"></button>


        <!-- all of the trades code -->
        <div id="side_panel" class="trades_side">


          <BR>

                    <!-- distance radius chooser -->
        <div id="distance_chooser">
          <form id="distance_form">
            <input id="distance_miles" type="text" title="Miles"> Miles From
            <input id="distance_from" type="text" title="From Zip"> Zip Code
            <input type="button" value="Find Leedz" id="distance_button">
          </form>

        </div>



          <BR>

            <div class="trades" >
              <ul id="trades_list">
          
          
                <template id="template_each_trade">
                  <li class="each_trade">
                    <input type="checkbox" class="trade_checkbox" />
                    <button class="trade_radio"></button>
                    <label></label><sup></sup>
                  </li>
                </template>          

              </ul>
            </div>

            <BR>




          </div>  

        
        </div>      


       
      <!-- CENTER COLUMN  -->      
      <div id="calendar_main" class="column _5">

           <!-- MONTH CHOOSER --> 
        <div id="months" class="row month_chooser">
          
          <div class="column _1" id="month-left"></div>
          <div class="column _7"><span id="month_label"></span></div>
          <div class="column _1" id="month-right"></div>

        </div>
    
        <!-- CALENDAR PANEL -->
        <div id="calendar_panel" class="row trades_calendar">
            <ul id="calendar_list">

              <template id="template_each_day">
                <li class="each_day">
                  <div class="dateSquare"><span></span></div>                
                </li>
              </template>          
            
            </ul>


          <div class="leed_thumbnail"></div>
        </div>
        
      </div>
        





      <!-- RIGHT COLUMN
        -- WELCOME PANEL / ACTION PANEL 
        -->
      <div id="welcome_panel" class="column _35">
        <div class="row">
          <span>
            <img id="welcome_logo" src="./img/logo_2.png">
          </span>
        </div>
          
        <div class="row">
          <div id="welcome_tag">Buy. Sell. Grow your hustle.</div>
        </div>

        
        <div class="row">
          <button class="button welcomeButton">How It Works</button>
       
        </div>      

        <div class="row">
          <button class="button welcomeButton">Contact Us</button>
       
        </div>      

        </div>





      <div id="action_panel" class="column _35">


        <div class="leed_info_container">
          <div class="row lic_row" id="leed_title">
            
            <div class="column lic_column"  id="lic_color">
                <button id="lic_trade_radio" class="trade_radio"></button>
            </div>

            <div class="column lic_column" id="lic_trade"></div>

            
            <div class="column lic_column" id="lic_date"></div>
          </div>




          <div class="row lic_row" id="event">
            <div class="column lic_column _3" id="event_label">Event</div>
            <div class="column lic_column _7" id="event_value"></div>
          </div>



          <div class="row lic_row" id="start-end">
            <div class="column lic_column _3" id="start-end_label">Time</div>
            <div class="column lic_column _7" id="start-end_value"></div>
          </div>

          <div class="row lic_row" id="loc">
            <div class="column lic_column _3" id="loc_label">Location</div>
            <div class="column lic_column _7" id="loc_value"></div>
          </div>
          

          <div class="row lic_row" id="details">
            <div class="column lic_column _3" id="details_label">Details</div>
            <div class="column lic_column _7" id="details_value"></div>
          </div>


          <div class="row lic_row" id="reqs">
            <div class="column lic_column _3" id="reqs_label">Requires</div>
            <div class="column lic_column _7" id="reqs_value"></div>
          </div>


          <div class="row lic_row" id="posted_by">
            <div class="column lic_column _3" id="posted_by_label">Posted By</div>
            <div class="column lic_column _7" id="posted_by_value"></div>
          </div>
          

          

          <div class="row lic_row" id="price">
            <div class="column lic_column _3" id="price_label">Price</div>
            <div class="column lic_column _7" id="price_value"></div>
          </div>


        </div>

        <BR>

        <div class="row">
          <button id="action_buy" class="button buy_button">Buy<img id="shopping_cart" src="img/shopping-cart.png"></button>
        </div>

        <a id="buy_modal_close" href="javascript:modalClose();">&#10140;</a>        
      </div>
      
    </div>





    <!-- 
      -- ERROR MODAL 
      -- 
      -->
    <div class="row modal" id="error_modal">
      <center><img id="error_logo" src="img/logo_2.png"></center> 
      <h1></h1>
      <a id="error_modal_close" href="javascript:modalClose();" href="">X</a>
    </div>





  </body>


  <script type="module" charset=”utf-8″>

    import { initUser, guestUser, getCurrentUser } from "./js/user.js";      
    import { initTradesColumn, getAllTrades } from "./js/trades.js";   
    import { loadCalendar, loadUserLeedz } from "./js/calendar.js";
    import { initMonthChooser } from "./js/months.js";
    import { printError, throwError } from "./js/error.js";



    const BUG_EMAIL = "<a href='mailto:scottgrossworks@gmail.com'>Report Error</a>"


        /* Set the width of the sidebar to 250px (show it) */
        export function openClose() {
          
          if (SIDE_OPEN) {
            closeNav();
            SIDE_OPEN = false;
          
          } else {
            openNav();
            SIDE_OPEN = true;
          }
        }
        window.openClose = openClose;


      


      export function modalClose() {

        let error = document.getElementById("error_modal");
        if (error != null) error.style.display = "none";

        let action = document.getElementById("action_panel");
        if (action != null) action.style.display = "none";

        let closeBut = document.getElementById("buy_modal_close");
        if (closeBut != null) closeBut.style.display = "none";

      }
      window.modalClose = modalClose;

       /**
         * DROP DOWN MENU
         */
         let DROP_DOWN = false;

         /* When the user clicks on the button,
         toggle between hiding and showing the dropdown content */
         export function dropdownMenu() {
           document.getElementById("dropdown_menu").classList.toggle("show");
           DROP_DOWN ^= 1; // flip flag
         }
         window.dropdownMenu = dropdownMenu;
         

      

      /**
       * FIXME FIXME FIXMEFIXME check for current Leed 
       * isLeedActive this entire block needs to be inside a module
       */
      function cssScreenSize() {

        var screen = getComputedStyle( document.documentElement ).getPropertyValue('--screen_size').trim();
        switch (screen) {
  
          case "S":
            SCREEN_SIZE = 0;
            SIDE_OPEN = false;  
            actionModal();
            break;
          
          case "M":
            // console.log("MED SCREEN");
            SCREEN_SIZE = 1;
            SIDE_OPEN = false;
            actionModal();
            break;
  
          case "L":
            // console.log("LARGE SCREEN");
            SCREEN_SIZE = 2;
            SIDE_OPEN = true;
             
            if ( false ) // FIXME FIXME is there a leed current?
              actionColumn();
            else
              welcomeColumn();
            
            break;
  
          default:
            console.error("--screen_size not found");
            SCREEN_SIZE = 3;
            SIDE_OPEN = false;
            actionModal();
            break;
        }
      }


      



      function errorModal( msg ) {

        let modal = document.getElementById("error_modal");
        modal.style.display = "block";


        let theMsg = modal.children[1]; /* the error text */
        theMsg.style.width = "90%";
        theMsg.innerHTML = msg + "<BR><BR>" + BUG_EMAIL;

      }



      function actionModal() {
        let welcome = document.getElementById("welcome_panel");
        welcome.style.display = "none";

        let action = document.getElementById("action_panel");
        action.classList.replace("column", "modal"); 
        
        let closeBut = document.getElementById("buy_modal_close");
        closeBut.style.display = "block";
      }


      function actionColumn() {

        let welcome = document.getElementById("welcome_panel");
        welcome.style.display = "none";

        let action = document.getElementById("action_panel");
        action.classList.replace("modal", "column");
        action.style.display = "flex";
        
        
        let closeBut = document.getElementById("buy_modal_close");
        if (closeBut != null) closeBut.style.display = "none";
     
      }


      

      function welcomeColumn() {

        let action = document.getElementById("action_panel");
        action.style.display = "none";

        let welcome = document.getElementById("welcome_panel");
        welcome.classList.replace("modal", "column");
        welcome.style.display = "flex";
        
        let closeBut = document.getElementById("buy_modal_close");
        if (closeBut != null) closeBut.style.display = "none";
      }



        function openNav() {
          side.style.width = "max-content";
     
          open.style.left = side.clientWidth + "px";
          open.innerHTML = "&#10140;"

          col.style.marginLeft = "0";
        }
   
        

        function closeNav() {
          side.style.width = "0";

          open.style.left = 0;
          open.innerHTML = "&#9776;"

          col.style.marginLeft = "-120px";
        }





   

          // Close the dropdown menu if the user clicks outside of it
          window.addEventListener( "click", (event) => {

            // console.log("GOT CLICK target=" + event.target);
            let theDiv = event.target;

            if (event.target.matches('a')) {
              // console.log("A=" + event.target);
              // triggered also for modal close
              //
              // FIXME FIXME FIXME
              // event.target will be http link

            } else if (! (event.target.matches('img'))) {
              // click -- not on a link and not on the dropdown image
              // HIDE THE DROPDOWN
              var dropdown = document.getElementById("dropdown_menu");
              dropdown.classList.remove("show");

            }
          }, true);

      
 
          



        
          let col = document.getElementById("trades_column");      
          let side = document.getElementById("side_panel");
          let open = document.getElementById("open_side_btn");
          
          let SIDE_OPEN = true;
          let SCREEN_SIZE = 0; // 0, 1, 2 small
          
    
 
          /**
          * 
          */

          cssScreenSize();

          /**
          * RESIZE
          * called on window resize -- but AFTER css applied -- can read values from 
          * different media_query css files depending on size
          */
          window.onresize = (event) => {
            cssScreenSize();
          };


          // set the trades sidebar      
          if (SIDE_OPEN) {
            openNav();
          } else {
            closeNav();
          }


          // WE COME HERE AFTER HOSTED LOGIN UI
          // (hopefully) we can pass username from the login to this page

          // LOAD user profile data
          // LOAD list of subscribed trades
          // do not fail on error -- load Guest User as default
          //
          // FIXME FIXME FIXME
          // FOOBAR FOOBAR FOOBAR
          // username will come from login sequence (hopefully)

         const USER_NAME = "dave.reyes";
         try {
            await initUser( USER_NAME ); // will throw error

          } catch (error) {

            // for the console
            printError("initUser()", error);

            // for the UI
            var msg = "Cannot load user data.<BR>Using guest account."
            msg = error + "<BR>" + msg;
            errorModal( msg );

            // DO NOT FAIL -- use guest user
            guestUser();
          }

          // whatever the current user identity -- continue ....

          // UPDATE the UI with the current user info
          const currentUser = getCurrentUser();
          let user_href = document.getElementById("user_href");
          user_href.setAttribute("href", currentUser.email);
          user_href.innerHTML = currentUser.username;



          
          /**
           * LOAD ALL trades and turn ON the ones subscribed to
           * when we turn ON a trade this will ALSO load the leedz
           * for each trade in currentUser.subs[]
           */
          let trades = [];
          try {
            await getAllTrades().then((response) => trades = response ); 
            
            if (trades == null) {
              throw new Error("server returned null trades.");
            }

            if (trades.length == undefined || trades.length == 0) {
              throw new Error("server returned empty (0) trades.");
            }

            // got ALL trades from DB
            initTradesColumn( trades );


          } catch (error) {
            
            // DO NOT FAIL -- show error modal dialog and print error to console
            var msg = "Cannot load trades.<BR>Please refresh page."
            msg = error.message + "<BR>" + msg;
            
            printError("Init Trades", error);
            errorModal( msg );
          }


          

          /**
           * INITIALIZE month chooser in middle column
           *
           */ 
           initMonthChooser();



          
          /**
           * LOAD central calendar column and any cached leedz
           */
           loadCalendar();


          /**
           * 
           */
          loadUserLeedz();



     </script>
  
  
 
   
   
   
   </body>
  </html>