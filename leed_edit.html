<!--
--
-- EDIT the current leed shown in the action window
-- the current user is the creator of the leed
--    
-->
   
<!DOCTYPE html>
<html lang="en">
	
	<head>
		 <meta charset="UTF-8">
		 <meta name="viewport" content="width=device-width, initial-scale=1.0">
	 
		 <TITLE>Edit Leed</TITLE>
	 
	 	<!-- Favicon -->
		 <link rel="shortcut icon" type="image/png" href="./img/favicon.png"> 
		 <link rel="icon" type="image/x-icon" href="./img/favicon.ico">
 
 
		 <link rel="stylesheet" href="./css/globals.css" type="text/css" />
		 <link rel="stylesheet" href="./css/leed_edit.css" tyep="text/css"/>
         <link rel="stylesheet" href="css/modal.css" type="text/css" />

		 <script src="./js/inline-edit.js" type="module" defer></script> 
	</head>


		 
	<center>


        

	<body>
	


			
        <div class="row" style="width:95vw;vertical-align:bottom;border-bottom: 2px solid var(--LEEDZ_DARKGREEN);">

			<div class="column _1">

				<a onclick="backButton()"><button class="back_button" style="margin:35px 20px; width:50px">&#10140;</button></a>
				</div>

				<div class="column" style="margin:auto 0;transform:translateY(6px)">
					<h1 class="user_title">Edit Leed</h1>
				</div>
				
				<div class="column _3" style="padding:6px;text-align:center">
				<img src="./img/logo_2.png" style="width:120px">
				</div>
			
			
		
			</div>


            <div id="alert_success" class="alert" style="display:none">
				<span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
			</div>

    



<section>
			
	<BR>	


<div class="row" style="width:96vw" id="form_container">

        <table cellspacing="5w" cellpadding="10px">



            <tr id="row_creator">
                            
                <TD class="labelTD">Creator: </TD>
                
                <td id="td_creator"></td>

                <td>
                   <!-- no edit button for creator  --> 
                </td>

                <TD class="eyeballTD"><img src="./img/eye_show.png"  id="2_eye" class="lock"></TD>
            </tr>



            <tr id="row_trade">
                <!-- 11/1/23 cannot change trade name at this time -->
                            
                <TD class="labelTD">Trade Name: </TD>
                
                <td id="td_trade"></td>

                <td></td>

                <TD class="eyeballTD"><img src="./img/eye_show.png"  id="3_eye" class="lock"></TD>
            </tr>



            <!-- TITLE -->
            <tr id="row_title">
                        
                <TD class="labelTD">Title: </TD>
                
                <td id="td_title" data-inlineType="text" data-inlineName="title" data-inlineRequired="1" data-inlinePlaceholder="(Required)"></td>

                <td data-inlineType="doneButton" class="buttonTD">
                    <input type="button" value="Edit" onclick="inlineEdit('row_title', editOptions)"/>
                </td>

               <TD class="eyeballTD"><img src="./img/eye_show.png" id="1_eye" class="lock"></TD>
            </tr>



            <!-- START TIME -->
            <tr id="row_start">
                        
                <TD class="labelTD">Start Time: </TD>
                
                <td id="td_start" data-inlineType="date" data-inlineName="start" data-inlineRequired="1" data-inlinePlaceholder="(Required)"></td>

                <td data-inlineType="doneButton" class="buttonTD">
                    <input type="button" value="Edit" onclick="inlineEdit('row_start', editOptions)"/>
                </td>

               <TD class="eyeballTD"><img src="./img/eye_show.png" id="6_eye" class="lock"></TD>
            </tr>


                    
            <!-- END TIME -->
            <tr id="row_end">
                        
                <TD class="labelTD">End Time: </TD>
                
                <td id="td_end" data-inlineType="date" data-inlineName="end" data-inlineRequired="1" data-inlinePlaceholder="(Required)"></td>

                <td data-inlineType="doneButton" class="buttonTD">
                    <input type="button" value="Edit" onclick="inlineEdit('row_end', editOptions)"/>
                </td>

                <!-- END TIME IS NOT LOCKED AND MAY BE HIDDEN -->
               <TD class="eyeballTD"><img src="./img/eye_show.png"  id="7_eye" onclick="toggleEyeball( 7 )"></TD>
            </tr>



            <!-- ADDRESS 
            -->
            <tr id="row_loc">
                        
                <TD class="labelTD">Address: </TD>
                
                <td id="td_loc" data-inlineType="text" data-inlineName="loc" data-inlineRequired="1" data-inlinePlaceholder="(Required)"></td>

                <td data-inlineType="doneButton" class="buttonTD">
                    <input type="button" value="Edit" onclick="inlineEdit('row_loc', editOptions)"/>
                </td>

                
               <TD class="eyeballTD"><img src="./img/eye_show.png" id="5_eye" eyeball="show" onclick="toggleEyeball( 5 )"></TD>
            </tr>




            


            <!-- EMAIL  -->
            <tr id="row_em">
                            
                <TD class="labelTD">Client Email: </TD>
                
                <td id="td_em" data-inlineType="email" data-inlineName="em" data-inlineRequired="0"></td>

                <td data-inlineType="doneButton" class="buttonTD">
                    <input type="button" value="Edit" onclick="inlineEdit('row_em', editOptions)"/>
                </td>

                <TD class="eyeballTD"><img src="./img/eye_show.png" id="8_eye" eyeball="show" onclick="toggleEyeball( 8 )"></TD>
            </tr>




            <!-- PHONE -->
            <tr id="row_ph">
                            
                <TD class="labelTD">Client Phone: </TD>
                
                <td id="td_ph" data-inlineType="tel" data-inlineName="ph" data-inlineRequired="0"></td>

                <td data-inlineType="doneButton" class="buttonTD">
                    <input type="button" value="Edit" onclick="inlineEdit('row_ph', editOptions)"/>
                </td>

                
                <TD class="eyeballTD"><img src="./img/eye_show.png" id="9_eye" eyeball="show" onclick="toggleEyeball( 9 )"></TD>
            </tr>





            <!-- LEED DETAILS -->
            <tr id="row_det">
                        
                <TD class="labelTD">Details: </TD>
                
                <td id="td_det" data-inlineType="text" data-inlineName="det" data-inlineRequired="1" data-inlinePlaceholder="(Required)"></td>

                <td data-inlineType="doneButton" class="buttonTD">
                    <input type="button" value="Edit" onclick="inlineEdit('row_det', editOptions)"/>
                </td>

                <TD class="eyeballTD"><img src="./img/eye_show.png" id="10_eye" eyeball="show" onclick="toggleEyeball( 10 )"></TD>
            </tr>



            
            <!-- LEED REQUIREMENTS -->
            <tr id="row_reqs">
                        
                <TD class="labelTD">Requirements: </TD>
                
                <td id="td_reqs" data-inlineType="text" data-inlineName="reqs" data-inlineRequired="0"></td>

                <td data-inlineType="doneButton" class="buttonTD">
                    <input type="button" value="Edit" onclick="inlineEdit('row_reqs', editOptions)"/>
                </td>

                <TD class="eyeballTD"><img src="./img/eye_show.png" id="11_eye" eyeball="show" onclick="toggleEyeball( 11 )"></TD>
            </tr>


            
            <!-- LEED PRICE -->
            <tr id="row_pr">
                        
                <TD class="labelTD">Price: </TD>
                
                <td id="td_pr" data-inlineType="text" data-inlineName="pr" data-inlineRequired="1" data-inlinePlaceholder="(Required)"></td>

                <td data-inlineType="doneButton" class="buttonTD">
                    <input type="button" value="Edit" onclick="inlineEdit('row_pr', editOptions)"/>
                </td>

               <TD class="eyeballTD"><img src="./img/eye_show.png" id="12_eye" class="lock"></TD>
            </tr>



                    


        </table>	

</div>


<!--
--
-- BUTTONS
--
--
--
-->

<div class="row">
        <!-- SAVE CHANGES BUTTON -->
        <button id="saveButton" class="button save_button" value="save" style="opacity:0.5" onclick="saveChanges()">Save Changes</button>
</div>
        


<div class="row">
        <!-- DELETE BUTTON -->
        <button id="delButton" class="button del_button" value="del" style="opacity:1.0" onclick="deleteLeed()">Delete Leed</button>
</div>



    <BR>
    <BR>



</section>  
        




  <!-- 
    -- ERROR MODAL 
    -- 
    -->
  <div class="row modal" id="error_modal">
    <center><img id="error_logo" src="img/logo_2.png"></center> 
    <h1></h1>
    <a id="error_modal_close" href="javascript:errorModalClose();" href="">X</a>
  </div>




</body>


	<script type="module">
			
        import { getWeekday, getHours, getMinutes, getShortMonthname, getMonthname } from "./js/dates.js";
        import { getShortDateString, DTfromPretty } from "./js/dates.js";
		
        import { inlineEmailFinishCell, inlineURLFinishCell } from "./js/inline-edit.js";
		import { inlineEdit } from "./js/inline-edit.js";
        import { getCurrentUser } from "./js/user.js";
        import { clearCurrentLeed, getCurrentLeed, blankLeedObject, saveLeedChanges, deleteCurrentLeed } from "./js/leed.js";
		import { printError, throwError, errorModal, errorModalClose } from "./js/error.js";
		
        import { LEED_KEYS, OPTS_LOCKED, OPTS_HIDDEN, OPTS_SHOWING, changeLeedOpts } from "./js/leed.js";
        import { USERNAME_URL_PARAM } from "./js/dbTools.js";


		window.inlineEdit = inlineEdit;
        window.errorModalClose = errorModalClose;
       
        const URL_LEED_DELETED = "./leed_delete.html";

        const CURRENT_USER = getCurrentUser(true);

		var EDITING = false;

		const CURRENT_LEED = getCurrentLeed(); 
        if (CURRENT_LEED == null)
            throwError("Cannot initialize leed editor: CURRENT_LEED is null");
    
        const LEED_CHANGES = blankLeedObject();

        // VERY IMPORTANT
        // we are editing the current leed
        // so the ids must match
        LEED_CHANGES.id = CURRENT_LEED.id;

        
        var element = null;
        
        // CREATOR
        //
        element = document.getElementById("td_creator");
        element.innerHTML = '<B>' + CURRENT_USER.un + '</B>';


        
        // FIXME
        console.log("CURRENT LEED")
        console.log(CURRENT_LEED);
        


        // TRADE
        // 11/1/23 -- cannot change trade once leed is created
        //
        element = document.getElementById("td_trade");
        element.innerHTML = CURRENT_LEED.tn;
        LEED_CHANGES.tn = CURRENT_LEED.tn;


        // TITLE
        // title of this leed
        element = document.getElementById("td_title");
        element.innerHTML = CURRENT_LEED.ti;


    // START DATE
        // 
        const startDate = new Date( CURRENT_LEED.st );
        const isoStart = startDate.toISOString();

        const start_weekday = getWeekday( getShortDateString( isoStart ) );
        const start_monthname = getShortMonthname( isoStart.substring(5, 7) ); 

        // remove '0' at front if any
        let start_date = isoStart.substring(8, 10);
        if (start_date.startsWith('0')) { start_date = start_date.substring(1) };

        const leed_year = isoStart.substring(0, 4);
        const hours_start = getHours(isoStart);
        const fullStartDate = start_weekday + " " + start_monthname + " " + start_date + ", " + leed_year; 
        const start_time = hours_start[0] + ":" + getMinutes(isoStart) + hours_start[1];
        element = document.getElementById("td_start");
        element.innerHTML = fullStartDate + " at " + start_time;


        
        // END DATE/TIME 
        //
       
        const endDate = new Date( CURRENT_LEED.et );
        const isoEnd = endDate.toISOString();
    
        const end_weekday = getWeekday( getShortDateString( isoEnd ) );
        const end_monthname = getShortMonthname( isoEnd.substring(5, 7) ); 
        
        // remove '0' at front if any
        let end_date = isoStart.substring(8, 10);
        if (end_date.startsWith('0')) { end_date = end_date.substring(1) };
        
        const hours_end = getHours(isoEnd);

        const fullEndDate = end_weekday + " " + end_monthname + " " + end_date + ", " + leed_year; 

        const end_time = hours_end[0] + ":" + getMinutes(isoEnd) + hours_end[1];

      

        // END TIME CAN BE HIDDEN OR SHOWN
        //
        element = document.getElementById("td_end");
        element.innerHTML = fullEndDate + " at " + end_time;
        if (CURRENT_LEED.op[ LEED_KEYS.ET ] == OPTS_HIDDEN )
            hideEyeball( LEED_KEYS.ET );


        // LOCATION
        // 
        element = document.getElementById("td_loc");
        element.innerHTML = CURRENT_LEED.lc;
        if (CURRENT_LEED.op[ LEED_KEYS.LC ] == OPTS_HIDDEN )
            hideEyeball( LEED_KEYS.LC );
            

        // EMAIL
        // 
        element = document.getElementById("td_em");
        if (CURRENT_LEED.em) element.innerHTML = CURRENT_LEED.em;
        if (CURRENT_LEED.op[ LEED_KEYS.EM ] == OPTS_HIDDEN )
            hideEyeball( LEED_KEYS.EM );


        // PHONE
        // 
        element = document.getElementById("td_ph");
        if (CURRENT_LEED.ph != 0) element.innerHTML = CURRENT_LEED.ph;
        if (CURRENT_LEED.op[ LEED_KEYS.PH ] == OPTS_HIDDEN )
            hideEyeball( LEED_KEYS.PH );


        // DETAILS
        // 
        element = document.getElementById("td_det");
        if (CURRENT_LEED.dt) element.innerHTML = CURRENT_LEED.dt;
        if (CURRENT_LEED.op[ LEED_KEYS.DT ] == OPTS_HIDDEN )
            hideEyeball( LEED_KEYS.DT );


        // REQS
        // 
        element = document.getElementById("td_reqs");
        if (CURRENT_LEED.rq) element.innerHTML = CURRENT_LEED.rq;
        if (CURRENT_LEED.op[ LEED_KEYS.RQ ] == OPTS_HIDDEN )
            hideEyeball( LEED_KEYS.RQ );


        // PRICE
        // 
        element = document.getElementById("td_pr");
        element.innerHTML = CURRENT_LEED.pr;



        //
        //        
        // console.log("GOT CURRENT LEED");
        // console.log(CURRENT_LEED);



        //
        //
        //
        //
		function backButton() {
			const CURRENT_USER = getCurrentUser(true);
	
			let href="./index.html?" + USERNAME_URL_PARAM + "=" + CURRENT_USER.un;
			window.open(href, "_self");

			clearCurrentLeed();
			self.close();

		}
		window.backButton = backButton;





        //
        //
        //
        //
        //
		function defaultCallback(rowData, rowName) {

			beginEditing();

			switch(rowName) {

                // case "row_trade":
                   // LEED_CHANGES.tn = rowData["trade"];
                   // break;

				case "row_title":
					LEED_CHANGES.ti = rowData["title"];
					break;

				case "row_start":
                    var dateTime = DTfromPretty( rowData["start"] );
					LEED_CHANGES.st = dateTime;
					break;

                case "row_end":
                    var dateTime = DTfromPretty( rowData["end"] );
                    LEED_CHANGES.et = dateTime;
                    break;


                case "row_em":
                    LEED_CHANGES.em = rowData["em"];
                    break;

                case "row_ph":
                    LEED_CHANGES.ph = rowData["ph"];
                    break;


                case "row_zip":
                    LEED_CHANGES.zp = rowData["zip"];
                    break;


				case "row_loc":
					LEED_CHANGES.lc = rowData["loc"];
					break;

				case "row_det":
					LEED_CHANGES.dt = rowData["det"];
					break; 
					
				case "row_reqs":
					LEED_CHANGES.rq = rowData["reqs"];
					break; 


				case "row_pr":
					LEED_CHANGES.pr = rowData["pr"];
					break; 

				default:
					printError("defaultCallback()", "received unknown form field: " + rowName);
					break;

			}
		}


        //
		//
		//
		//
		function beginEditing() {

       
			var element = document.getElementById("saveButton");
			element.innerHTML = "Save Changes";
			element.style.backgroundColor = "var(--LEEDZ_GREEN)";
			element.style.opacity = 1;

			EDITING = true;
		}


		//
		//
		//
		function endEditing() {
			var element = document.getElementById("saveButton");
			element.innerHTML = "Saved!";
			element.style.backgroundColor = "darkorange";
			element.style.opacity = 0.5;

			EDITING = false;
		}


        


        //
        // Used for startup init
        // DOES NOT beginEditing()
        //
        function hideEyeball( fieldName ) {
            
            let theImg = document.getElementById(fieldName + "_eye");
        
                theImg.src = "./img/eye_hide.png";
                theImg.eyeball = "hide";
                // theImg.style.opacity = 1;
                
                // 11/2023
                // just nuts -- highlight the text
                theImg.parentElement.parentElement.children[1].style.color = "green";
                
                changeLeedOpts( LEED_CHANGES, fieldName, OPTS_HIDDEN );
       

        }
        window.hideEyeball = hideEyeball;




        //
        // Called by UI buttons
        // DOES NOT beginEditing()
        //
        function toggleEyeball( fieldName ) {
            
            beginEditing();


            let theImg = document.getElementById(fieldName + "_eye");
      

            if (theImg.eyeball == "hide") {

                theImg.src = "./img/eye_show.png";
                theImg.eyeball = "show";
                // theImg.style.opacity = 1;

                theImg.parentElement.parentElement.children[1].style.color = "black";


                changeLeedOpts( LEED_CHANGES, fieldName, OPTS_SHOWING );

            } else {
                
                hideEyeball(fieldName);
            }

        }
        window.toggleEyeball = toggleEyeball;

        


    /**
    *
    *
    */
    async function saveChanges() {

        if (! EDITING) return;

        waitCursor();

        //   client <---> API Gateway <===> DB
        //
        //
        let from_DB = null;
        try {
            await saveLeedChanges(LEED_CHANGES).then((response) => from_DB = response ); 

        } catch ( error ) {
            errorModal("Error saving changes: " + error.message, false);

        } finally {
            endEditing();
            normalCursor();
        }

        console.log("GOT RESULTS!!!");
        console.log(from_DB)

            /**
             * SHOW THE ERROR ALERT
             */
        if (from_DB.er) {
            var msg = "Error adding leed: " + LEED_CHANGES.ti + " : " + from_DB.er;
            printError("Save Leed Changes", msg);
            errorModal(msg, true);

        } else {
           /**
            * SHOW THE SUCCESS ALERT
            *
            *  result = "{'id': " + id + ",'ti':" + ti + ",'pr':" + pr + ",'cd': 1}" 
            *            {'id': 15013540,'ti':2222 FairFax Airbrush Title,'pr':55,'cd': 1}
            */
            var theAlert = document.getElementById("alert_success");
            var msg = 'Leed Updated: ' + from_DB.ti + '  ($ ' + from_DB.pr +' )';
            var newChild = document.createElement("span");
            newChild.textContent = msg;
            theAlert.appendChild(newChild);
            theAlert.style.display = "block";
        }   




    }
    window.saveChanges = saveChanges;




    /**
    *
    *
    */
    async function deleteLeed() {

        endEditing();

        waitCursor();

        let from_DB = null;
        try {

            // GO BACK to server and delete leed
            // compliment of add leed

            from_DB = await deleteCurrentLeed();

        } catch ( error ) {
            printError("Delete Leed", error.message);
            errorModal("Error deleting leed: " + error.message, false);

        } finally {
            
            normalCursor();
            clearFields();
        }

        
        // success or failure
        console.log("GOT RESULTS!!!");
        console.log(from_DB)
        if (! from_DB) return;


        /**
        * SHOW THE ERROR ALERT
        * will not get here if create throws exception above
        * This is a catch-all for null responses and
        * HTTP 200 codes that contain error messages 
        */
        if (from_DB.er) {
            var msg = "Error deleting leed: " + from_DB.er;
            printError("Delete Leed", msg);
            errorModal(msg, false);

        } else {

          /**
            * SHOW THE SUCCESS ALERT
            *
            *  result = "{'id': " + id + ",'ti':" + ti + ",'pr':" + pr + ",'cd': 1}" 
            *            {'id': 15013540,'ti':2222 FairFax Airbrush Title,'pr':55,'cd': 1}
            */
            var theAlert = document.getElementById("alert_success");
            var msg = 'Deleted leed:  ' + from_DB.ti + '  ($ ' + from_DB.pr +' )';
            var newChild = document.createElement("span");
            newChild.textContent = msg;

            if (theAlert.children.length <= 1) {
                theAlert.appendChild(newChild);
            } else {
                theAlert.replaceChild(newChild, theAlert.children[1]);
            }

            theAlert.style.display = "block";

        }   

    }
    window.deleteLeed = deleteLeed;




        /**
         * Clear all fields and start over
         *
         */
         function clearFields() {
           
            inlineEdit('row_trade', cancelOptions);            
            inlineEdit('row_title', cancelOptions);
            inlineEdit('row_start', cancelOptions);
            inlineEdit('row_end', cancelOptions);
            inlineEdit('row_loc', cancelOptions);
            inlineEdit('row_em', cancelOptions);
            inlineEdit('row_ph', cancelOptions);
            inlineEdit('row_det', cancelOptions);
            inlineEdit('row_reqs', cancelOptions);
            inlineEdit('row_pr', cancelOptions);
		}
		window.clearFields = clearFields;


		var cancelOptions = {   "origin": "cancel",
                                "finishCallback": defaultCallback };
		window.cancelOptions = cancelOptions;


        /**
         *
         *
         */
		var editOptions = { "origin" : "edit",
                            "finishCallback": defaultCallback 
                            };
		window.editOptions = editOptions;


	



        /**
        * Change to a wait cursor
        */
        function waitCursor() {
            document.body.style.cursor = 'wait';
        }
        window.waitCursor = waitCursor;

        /**
        * Change back to normal cursor
        */
        function normalCursor() {
            document.body.style.cursor = 'default';
        }
        window.normalCursor = normalCursor;

	
	</script>

	
		


</html>