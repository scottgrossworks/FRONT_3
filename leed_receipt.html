<!--
--
-- LEED RECEIPT -- show receipt info
--    
-->

<!DOCTYPE html>
<html lang="en">
	


<head>
    <link rel="stylesheet" href="css/globals.css" type="text/css" />
    <link rel="stylesheet" href="css/modal.css" type="text/css" />


        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
        <TITLE>Leed Receipt</TITLE>
    
        <link rel="shortcut icon" type="image/png" href="./img/favicon.png"> 
        <link rel="icon" type="image/x-icon" href="./img/favicon.ico">

        <link rel="stylesheet" href="css/dropdown.css" type="text/css" />
        <link rel="stylesheet" href="./css/globals.css" type="text/css" />
        <link rel="stylesheet" href="./css/leed_edit.css" tyep="text/css"/>


        <script src="./js/inline-edit.js" type="module" defer></script> 
</head>


		 
            
<center>


<body>


    <div class="row" style="left:0;width:95vw;vertical-align:bottom;border-bottom: 2px solid var(--LEEDZ_DARKGREEN);">


        <div class="column _1">
            <a onclick="history.go(-2)"><button class="back_button" style="margin:35px 20px; width:50px">&#10140;</button></a>
        </div>


        <div class="column _8" style="margin:auto 0;transform:translateY(6px)">
            <h1 class="user_title">Leed Receipt</h1>
        </div>


        <div class="column _2 dropdown" style="margin:auto 0;">

            <span><a href="javascript:dropdownMenu();"><img src="./img/logo_dd.png" style="height:80px"></a></span>
            <div id="dropdown_menu" class="dropdown-content">

                <a href="./leedz_how-to.html" id="dd_howto">How To</a>
                
                <a href="./leedz_about.html">About</a>

                <a href="./leedz_contact.html">Contact</a>

            </div>

        </div>
    </div>


    
    <section>
        
    
    

    <!-- 
    -- ERROR MODAL 
    -- 
    -->
    <div class="row modal" id="error_modal" style="display:none">
    <center><img id="error_logo" src="img/logo_2.png"></center> 
    <h1></h1>
    <a id="error_modal_close" href="javascript:errorModalClose();" href="">X</a>
    </div>



    <BR>

    <!--
    --  RECEIPT INFO
    -->

    <!-- BUYER -->
    <div style="font-size:larger;font-weight:600">
        Congratulations <b style="color:green"><span id="user_welcome"></span></b>, you bought a leed!
        <BR>Check your email <b style="color:green"><span id="user_email"></span></b> for this receipt.
    </div>


    <div class="row" id="leed_info">

        <table>


            <!-- CREATOR -->
            <tr id="row_cr">
                            
                <TD class="labelTD">Creator: </TD>
                
                <td id="td_cr"></td>

                <td>
                </td>
            </tr>


            <!-- TRADE NAME -->
            <tr id="row_tn">
                            
                <TD class="labelTD">Trade Name: </TD>
                
                <td id="td_tn"></td>

                <td>
                </td>
            </tr>


            <!-- TITLE -->
            <tr id="row_ti">
                        
                <TD class="labelTD">Title: </TD>
                
                <td id="td_ti"></td>

                <td>
                </td>
            </tr>


            <!-- START TIME -->
            <tr id="row_st">
                        
                <TD class="labelTD">Start Time: </TD>
                
                <td id="td_st"></td>

                <td>
                </td>
            </tr>

                    
            <!-- END TIME -->
            <tr id="row_et">
                        
                <TD class="labelTD">End Time: </TD>
                
                <td id="td_et"></td>

                <td>
                </td>
            </tr>


            <!-- LOC ADDRESS -->
            <tr id="row_lc">
                        
                <TD class="labelTD">Location: </TD>
                
                <td id="td_lc"></td>

                <td>
                </td>
            </tr>


            <!-- EMAIL -->
            <tr id="row_em">
                        
                <TD class="labelTD">Email: </TD>
                
                <td id="td_em"></td>

                <td>
                </td>
            </tr>

            

            <!-- PHONE -->
            <tr id="row_ph">
                        
                <TD class="labelTD">Phone: </TD>
                
                <td id="td_ph"></td>

                <td>
                </td>
            </tr>


            <!-- DETAILS -->
            <tr id="row_dt">
                        
                <TD class="labelTD">Details: </TD>
                
                <td id="td_dt"></td>

                <td>
                </td>
            </tr>


                    
            <!-- REQUIREMENTS -->
            <tr id="row_rq">
                                
                <TD class="labelTD">Requirements: </TD>
                
                <td id="td_rq"></td>

                <td>
                </td>
            </tr>



            <!-- PRICE -->
            <tr id="row_pr">
                        
                <TD class="labelTD">Price: </TD>
                
                <td id="td_pr"></td>

                <td>
                </td>
            </tr>

        </table>	
    </div>
</section>  

  <BR>


    <div id="copyright_footer">
        <span>
          All content is &copy;2024 The Leedz, all rights reserved, and may not be reproduced for commercial purposes without written permission.
        </span>
      </div>



</body>

<!--
    This is coming from the square_leedbought callback lambda function
    The transaction is approved (or not)
    The callback processes the results
    this url is encoded in the ORIGINAL payment link sent to the user in getDeetz()
    Square sends user here
    https://www.theleedz.com/leed_receipt.html?
        id=1059445987
        &
        bn=theleedz
        &
        transactionId=LO3AyBjsoVUUFJul27DXQF4V9pfZY
        &
        orderId=LO3AyBjsoVUUFJul27DXQF4V9pfZY
-->
<script type="module">
			
    import { formatDTforInput } from "./js/dates.js";
    import { printError, throwError, errorModal, errorModalClose } from "./js/error.js";
    import { getCurrentUser } from "./js/user.js";
    import { LEED_KEYS, OPTS_HIDDEN, SHOW_ALL_OPTS, setCurrentLeed, getCurrentLeed } from "./js/leed.js";

    import { USERNAME_URL_PARAM, db_getDeetz } from "./js/dbTools.js";


    window.errorModalClose = errorModalClose;
    
    // Get the query string from the URL
    const queryString = window.location.search;

    // Create a new instance of URLSearchParams with the query string
    const params = new URLSearchParams(queryString);

    const leed_id = params.get('id');
    const buyer_name = params.get('bn');

    if ((! leed_id) || (! buyer_name)) {
        // ERROR !
        var err_msg = "Incorrect URL parameters in leed_receipt.html callback";
        printError( "Leed Receipt", err_msg );
        errorModal("Cannot load leed receipt: " + err_msg, true);
        throwError(err_msg);
    }

    const sq_tid = params.get('transactionId');
    const sq_oid = params.get('orderId');

    if ((! sq_tid) || (! sq_oid)) {
        // ERROR !
        var err_msg = "No Order ID or Transaction ID found";
        printError( "Leed Receipt", err_msg );
        errorModal("Leed not bought: " + err_msg, true);
        throwError(err_msg);
    }   

    //
    // SUCCESS !!
    //
    console.log("Leed Receipt: " + new Date());
    console.log("Leed ID: " + leed_id);
    console.log("Buyer: " + buyer_name);
    console.log("Square Transaction ID: " + sq_tid);
    console.log("Square Order ID: " + sq_oid);


    // LOAD THE CURRENT USER
    //
    const CURRENT_USER = getCurrentUser(true);
    if ((! CURRENT_USER) || (! CURRENT_USER.un)) {
        // ERROR !
        printError("Leed Receipt", "No current user");
        errorModal("No current user logged in.", true);
        throwError(err_msg);

    } else if (CURRENT_USER.un != buyer_name) {
        // ERROR !
        var err_msg = "Current user does not match leed buyer";
        printError("Leed Receipt", err_msg);
        errorModal(err_msg, true);
        throwError(err_msg);


    } else {
        
        // LOAD THE CURRENT LEED
        //
        const leed_preview = getCurrentLeed();
        if (leed_id != leed_preview.id) {
            // ERROR !
            var err_msg = "Current leed does not match leed bought";
            printError("Leed Receipt", err_msg);
            errorModal(err_msg, true);
            throwError(err_msg);
        }

        // SUCCESS !!
        //
        loadPage(CURRENT_USER, leed_preview);
    }



    //
    // FULL REFRESH leed details with SHOW_ALL options
    //
    function loadPage(CURRENT_USER, leed_preview) {
        
        let user_welcome = document.getElementById("user_welcome");
        user_welcome.innerText = CURRENT_USER.un;
       
        let user_email = document.getElementById("user_email");
        user_email.innerText = CURRENT_USER.em;


        const LEED_BOUGHT = getLeedDeetz(CURRENT_USER, leed_preview);
 

        var the_div = document.getElementById("td_cr");
        the_div.innerText = LEED_BOUGHT['cr'];
        
        var the_div = document.getElementById("td_tn");
        the_div.innerText = LEED_BOUGHT['tn'];
        
        var the_div = document.getElementById("td_ti");
        the_div.innerText = LEED_BOUGHT['ti'];
        
        var the_div = document.getElementById("td_st");
        the_div.innerText = formatDTforInput(LEED_BOUGHT['st']);
        
        var the_div = document.getElementById("td_et");
        the_div.innerText = formatDTforInput(LEED_BOUGHT['et']);
        
        var the_div = document.getElementById("td_lc");
        the_div.innerText = LEED_BOUGHT['lc'];
        
        var the_div = document.getElementById("td_dt");
        the_div.innerText = LEED_BOUGHT['dt'];
        
        var the_div = document.getElementById("td_rq");
        the_div.innerText = LEED_BOUGHT['rq'];
        
        var the_div = document.getElementById("td_em");
        the_div.innerText = LEED_BOUGHT['em'];
        
        var the_div = document.getElementById("td_ph");
        the_div.innerText = LEED_BOUGHT['ph'];
        
        //
        // PRICE
        //
        var the_div = document.getElementById("td_pr");
        var the_price =  '$ ' + LEED_BOUGHT['pr'];
        the_div.innerText = the_price;
        console.log("Price: " + the_price);
        
    }



    

    /**
    * full refresh of leed details with SHOW_ALL_OPTS
    */
    export async function getLeedDeetz( CURRENT_USER, leed_preview ) {

        // API request --> DB   
        // load full leed details for leed_preview.id
        //
        try {

            await db_getDeetz( CURRENT_USER.un, leed_preview.tn, leed_preview.id, SHOW_ALL_OPTS )
                .then((data) => {

                    if (! data) throw new Error("null response from GET");
                    const leed_details = data;
                    
                    // query returns empty result set
                    if (! leed_details)
                        throw new Error("No leed details for id: " + leed_preview.id);
                    
                    // COPY leed details into current leed object 
                    setCurrentLeed(leed_details);

                    return leed_details;

                })
            .catch(error => {
                throw error;            
            })
        } catch ( error ) {

            printError( "db_getDeetz()", error.message );
            errorModal("Cannot get leed details for [" + leed_preview.tn + "] " + leed_preview.id, true);
            
        }
    }

        
    </script>

</html>
