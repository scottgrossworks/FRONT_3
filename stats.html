<!-- 
    --
    --
    -->
   
    <!DOCTYPE html>
    <html lang="en">
    
    <head>
         <meta charset="UTF-8">
         <meta name="viewport" content="width=device-width, initial-scale=1.0">
     
         <title>Welcome to the Leedz</title>
     
    <!-- Favicon -->
    <link rel="shortcut icon" type="image/png" href="./img/favicon.png"> 
    <link rel="icon" type="image/x-icon" href="./img/favicon.ico">

    <link rel="stylesheet" href="./css/globals.css" type="text/css" />
    <link rel="stylesheet" href="./css/stats.css" type="text/css" />
    <link rel="stylesheet" href="./css/trades.css" type="text/css" />
    <link rel="stylesheet" href="css/dropdown.css" type="text/css" />

    
    <script src="./js/trades.js" type="module" defer></script>
    <script src="./js/error.js" type="module" defer></script>
    <script src="./js/dbTools.js" type="module" defer></script>

 
   </head>  
    
   <body>


    <div class="row" id="stats_header">


                
        <div class="column dropdown _2">

            <span id="up_logo"><a href="javascript:dropdownMenu();">
                <img id="dropdown_logo" src="./img/logo_dd.png"></a></span>
            <div id="dropdown_menu" class="dropdown-content">

                <a href="#" onclick="" style='color:green;' id="dd_login">Login</a>

                <a href="./leedz_how-to.html" id="dd_howto">How To</a>

                <a href="./leedz_about.html">About</a>

                <a href="./leedz_contact.html">Contact</a>

                <a href="./leedz_contact.html">For Investors</a>

                <a href="./leedz_privacy.html">Privacy</a>

             </div>
        </div>

        

        <div class="column header_col _55">
            <center>Buy. Sell. Grow your Hustle.</center>
        </div>
                

        <div class="column login_col _15">

        <!-- LOGIN BUTTON -->
        <button  class="button stats_button" value="login" onclick="">Login</button>

        </div>

        <div class="column _1"></div>
    </div>



    
    <div class="row" id="links_header">

        <a href="./leedz_how-to.html">How-To</a>
        <a href="./leedz_about.html">About</a>
        <a href="./leedz_contact.html">Contact</a>
        <a href="./leedz_contact.html">Join Us</a>
    </div>


    <div class="container">
        


        



        <div class="item" id="leedz_leaders">
            <div class="item_title" style="width:100%">Leedz Leaders</div>
     
            <table>
     
                <TR>
                    <TD><b>Leedz</b> for sale: <a id="leedz_posted"></a></TD>
                </TR>

                <TR><TD><b>Total bought: <a id="leedz_bought"></a></TD></TR>

                <TR>
                    <TD><b>Total trades: </b><a id="trades_total"></a></TD>
                </TR>

            </table>
        </div>


        <div class="item" id="last_sale">
            <div class="item_title" style="width:100%">Leedz Latest</div>
     
                    <table>
                        <TR><TD id="trade_div">
                            <!-- TRADE DIV -->
                            <b>Trade: </b>
                        <template id="template_each_trade">
                            <span class="each_trade" style="display:inline-block;padding-right:4px">
                                <button class="trade_radio" 
                                style="transform:translate(2px, 3px);"></button>
                                <label></label><sup></sup>
                                
                            </span>
                        </template>
                    
                    </TD></TR>

                        <TR><TD><a class="stats_date" id="date_bought_3"></a></TD></TR>
                        <TR><TD><b>Where:</b> <a id="sale_zip_2"></a></TD><TR>
                        <TR><TD><b>Sold for:</b> <a id="sale_price_2"></a></TD><TR>
                    </table>

        </div>






        
        

        <div class="item" id="login_item">
            <div class="item_title" style="width:100%">Secure Login</div>
            <span>Your privacy protected by Amazon Web Services.</span>
            <!-- LOGIN BUTTON -->
            <table><TR>
                <TD>
                    <img src="img/aws.png">
                </TD>
                <TD>
                    <button id="loginButton" class="button stats_button" value="login" style="" onclick="">Login</button>
                </TD>
            </TR></table>

            
        </div>



        



        
        <div class="item" id="top_trades">

            <div class="item_title" style="width:100%">Top Trades</div>
            <table>
                <TR>
                    <TD><b>The top <a id="maxTrades"></a> trades by <b style=color:green>leedz for sale:</b></b></TD>
                </TR>                
                <TR>
                    <td id="trades_table">

                        <template id="template_each_trade">
                            <span class="each_trade" style="display:inline-block;padding-right:4px">
                                <button class="trade_radio" 
                                style="transform:translate(2px, 3px);"></button>
                                <label></label><sup></sup>
                                
                            </span>
                        </template>
                    </td>
                </TR>
            </table>


        </div>





        <div class="item" id="leedz_live">
            <div class="item_title" style="width:100%">Leedz Live</div>
     
            <table>
                <TR><TD><b>Last post:</b></TD></TR>    
                <TR><TD><a id="date_posted"></a></TD></TR>

                <TR><TD><b>Last sale:</b></TD></TR>    
                <TR><TD><a id="date_bought_2"></a></TD></TR>

            </table>
        </div>
        

        <div class="item" id="contact_item">
            <div class="item_title" style="width:100%">Contact the Leedz</div>

            <BR>
                <ul type="disc">
                
                    <li>How-To Hustle</li>
                    <li>Join our Team</li>
                    <li>Suggest a new trade</li>
                    <li>Report a Bug</li>
    
                </ul>
           <BR>
           
            <!-- LOGIN BUTTON -->
            <button id="contactButton" class="button stats_button" value="contact" style="padding-right:20px" onclick="">Contact</button>

            
        </div>





    </div>
    <BR>
    <BR>
        
    <div class="row" id="stats_footer">
        <span>
        All content is &copy;2024 The Leedz, all rights reserved, and may not be reproduced for 
        commercial purposes without written permission.
        </span>
    </div>

</body>







<script type="module" charset=”utf-8″>
	import { turnTrade_On, turnTrade_Off, getAllTrades, createTradesAndColors } from "./js/trades.js";
    import { db_getStats } from "./js/dbTools.js";
    import { printError, errorModal, throwError } from "./js/error.js";
    import { prettyFormatDT, formatDTforInput } from "./js/dates.js";

    const MAX_TRADES = 6;



    

       /**
         * DROP DOWN MENU
         */
         let DROP_DOWN = false;

         /* When the user clicks on the button,
         toggle between hiding and showing the dropdown content */
         export function dropdownMenu() {

          const menu = document.getElementById("dropdown_menu");
          menu.classList.toggle("show");

           DROP_DOWN ^= 1; // flip flag
         }
         window.dropdownMenu = dropdownMenu;
         





         


          //
          // ANY window click registers here
          //
          window.addEventListener( "click", (event) => {

       
            if (event.target.matches('a')) {
              
              // event.target will be http link
              window.open( event.target , "_self");
            
            } else if (! (event.target.matches('img'))) {
                var dropdown = document.getElementById("dropdown_menu");
                dropdown.classList.remove("show");

            }
           

          }, true);








/**
 * 
 * 
 */
 async function initStats() {

	waitCursor();
    try {
        const stats = await getStats();
            

        if (! stats) {
            throw new Error("server returned null stats.");
        }

        console.log("STATS=");
        console.log(stats);

        var element;
        
        element = document.getElementById("leedz_posted");
        element.innerHTML = stats.lp;

        
        element = document.getElementById("leedz_bought");
        element.innerHTML = stats.lb;

        // date posted
        let the_date = prettyFormatDT( formatDTforInput( stats.dp ) );
        element = document.getElementById("date_posted");
        element.innerHTML = the_date;

        // date bought
        the_date = prettyFormatDT( formatDTforInput( stats.db ) );

        element = document.getElementById("date_bought_2");
        element.innerHTML = the_date;
        element = document.getElementById("date_bought_3");
        element.innerHTML = the_date;


        // trade of last bought leed
        addToTradeDiv( stats.ab );


        element = document.getElementById("sale_price_2");
        element.innerHTML = '$ ' + stats.pr;

        element = document.getElementById("sale_zip_2");
        element.innerHTML = stats.zp;

    } catch (error) {
        
        // DO NOT FAIL -- show error modal dialog and print error to console
        var msg = "Cannot load stats.<BR>Please refresh page."
        msg = error.message + "<BR>" + msg;
        
        printError("Init Stats", error);
        // errorModal( msg , true );

    } finally {
        normalCursor();
    }


  }


    

/**
 * 
 * 
 */
 async function getStats() {
    try {
      const result = await db_getStats();
      return result;
    } catch (error) {
      // Handle any errors that occur during the fetch request
      throw error;
    }
}



/**
 * 
 * 
 */
 async function initTrades() {

	let trades = [];
  
	waitCursor();

	try {
	  await getAllTrades().then((response) => trades = response ); 
  
		if (trades == null) {
		  throw new Error("server returned null trades.");
		}
  
		if (trades.length == undefined || trades.length == 0) {
		  throw new Error("server returned empty (0) trades.");
		}



		// init TRADES struct
		// initialize the spectrum of colors
		createTradesAndColors( trades );  
		


		initTradesTable( trades );

        

  
	  } catch (error) {
		
		// DO NOT FAIL -- show error modal dialog and print error to console
		var msg = "Cannot load trades.<BR>Please refresh page."
		msg = error.message + "<BR>" + msg;
		
		printError("Init Trades Column", error);
		// errorModal( msg , true );
	
	} finally {
		normalCursor();
	}
  }


	





/**
 *
 * all_trades is the array 
 * 
 * ONLY display the trades to which the user is subscribed
 * [
 * {
   tn: "caricatures",
   nl: 5
 * }, .... 
 * ]
*/
function initTradesTable( all_trades ) {

	if ((all_trades == null) || (all_trades.length == 0)) return;
  

    var element = document.getElementById("maxTrades");		
    element.innerHTML = MAX_TRADES;

    element = document.getElementById("trades_total");
    element.innerHTML = all_trades.length;


	// import DOM elements from html
	const theList = document.querySelector("#trades_table");
	const subs = [];
	const theTemplate = document.querySelector("#template_each_trade");

    var count = 0;
	all_trades.forEach((trade) => {

        if (++count > MAX_TRADES) return;

        // clone a new node
        const newNode = theTemplate.content.cloneNode(true).querySelector(".each_trade");

        // set the label
        let theLabel = newNode.querySelector("label");
        theLabel.textContent = trade.sk;
        
        // set the leed count as a superscript
        newNode.querySelector("sup").textContent = trade.nl;

        let radioButton = newNode.querySelector(".trade_radio");
        turnTrade_On(null, radioButton, theLabel, trade.sk);

        theList.appendChild( newNode );
	});

    
}


	

/**
 * The trade of the last sale
 *
 */
function addToTradeDiv( trade_name ) {
    const theList = document.querySelector("#trade_div");
    const theTemplate = document.querySelector("#template_each_trade");

    // clone a new node
    const newNode = theTemplate.content.cloneNode(true).querySelector(".each_trade");

    // set the label
    let theLabel = newNode.querySelector("label");
    theLabel.textContent = trade_name;

    let radioButton = newNode.querySelector(".trade_radio");
    turnTrade_On(null, radioButton, theLabel, trade_name);


    theList.appendChild( newNode );
}



/**
 * Change to a wait cursor
 */
 function waitCursor() {
    document.body.style.cursor = 'wait';
}

/**
 * Change back to normal cursor
 */
function normalCursor() {
    document.body.style.cursor = 'default';
}




/**
 * WINDOW OPEN 
 * PAGE LOAD
 *
 */
window.onload = async function() {
    await initTrades();
    await initStats();
}



</script>

</body>
</html>