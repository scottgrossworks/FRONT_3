
<!--
--
-- EDIT the current user profile logged in
--    
-->   
<!DOCTYPE html>
<html lang="en">
	
	<head>
		 <meta charset="UTF-8">
		 <meta name="viewport" content="width=device-width, initial-scale=1.0">
	 
		 <TITLE>LEEDZ User Info</TITLE>
	 
	 	<!-- Favicon -->
		 <link rel="shortcut icon" type="image/png" href="./img/favicon.png"> 
		 <link rel="icon" type="image/x-icon" href="./img/favicon.ico">
 
		 <link rel="stylesheet" href="./css/user_edit.css" tyep="text/css"/>

		 <link rel="stylesheet" href="./css/globals.css" type="text/css" />
		 <link rel="stylesheet" href="./css/trades.css" type="text/css" />
         <link rel="stylesheet" href="./css/modal.css" type="text/css" />

		 <script src="./js/inline-edit.js" type="module" defer></script> 
		 <script src="./js/trades.js" type="module" defer></script>
		 <script src="./js/error.js" type="module" defer></script>
		 <script src="./js/dbTools.js" type="module" defer></script>
	</head>


		 
	<center>


	<body>
	


			
			<div class="row" style="width:95vw;vertical-align:bottom;border-bottom: 2px solid var(--LEEDZ_DARKGREEN);">

			<div class="column _1">

				<button class="back_button" style="margin:35px 20px; width:50px"><a onclick="backButton()">&#10140;</a></button>
				</div>

				<div class="column" style="margin:auto 0;transform:translateY(6px)">
					<h1 class="user_title">Edit Account</h1>
				</div>
				
				<div class="column _3" style="padding:6px;text-align:center">
				<img src="./img/logo_2.png" style="width:120px">
				</div>
			
			
		
			</div>


			
<section>

	<BR>	
	<BR>


			
<div class="row" id="form_container">

				<table cellspacing="5vw">
					

					<tr id="row_username">
					
						<TD class="labelTD">Username: </TD>
						
						<td colspan=2 id="td_username" data-inlineType="text" data-inlineName="username" 
						data-inlineRequired="true" data-inlinePlaceholder="(Required)" style="color:green;font-weight:600;font-size:1.5em;"></td>
		
						
					</tr>




					<tr id="row_login">
					
						<TD class="labelTD">Login &amp; Password: </TD>
						<td data-inlineType="text" data-inlineName="login"></td>
		
						<!-- FIXME FIXME FIXME 
						URL TO CHANGE LOGIN / PASSWORD
						-->

						<td data-inlineType="doneButton" class="buttonTD">
							<input type="button" value="Edit" onclick=""/>
						</td>
					</tr>





					<tr id="row_payment">
					
						<TD class="labelTD">Payment Information: </TD>
						<td data-inlineType="text" data-inlineName="payment"></td>
						

						<!-- FIXME FIXME FIXME 
						URL TO CHANGE PAYMENT INFO
						-->


						<td data-inlineType="doneButton" class="buttonTD">
							<input type="button" value="Edit" onclick=""/>
						</td>
					</tr>






				<tr id="row_email">
					
					<TD class="labelTD">Email: </TD>
					
					<td id="td_email" data-inlineType="email" data-inlineName="email" data-inlineRequired="true" data-inlinePlaceholder="(Required)"></td>
	
					<td data-inlineType="doneButton" class="buttonTD">
						<input type="button" value="Edit" onclick="inlineEdit('row_email', emailOptions)"/>
					</td>
				</tr>



				<tr id="row_website">
					
					<TD class="labelTD">Website: </TD>
					
					<td id="td_website" data-inlineType="link" data-inlineName="website" data-inlineRequired="0" data-inlinePlaceholder="(Website)"></td>
	
					<td data-inlineType="doneButton" class="buttonTD">
						<input type="button" value="Edit" onclick="inlineEdit('row_website', urlOptions)"/>
					</td>
				</tr>



				<tr id="row_about">

					<TD class="labelTD">About Me: </TD>
					
					<td id="td_about" data-inlineType="textarea" data-inlineName="about">Help sell the leedz you post</td>
					
					
					<td data-inlineType="doneButton" class="buttonTD">
						<input type="button" value="Edit" onclick="inlineEdit('row_about', defaultOptions)"/>
					</td>
				</tr>

				





				<tr id="row_zip">
					
					<TD class="labelTD">Zip Code: </TD>
					
					<td id="td_zip" data-inlineType="zip" data-inlineName="zip" 
					data-inlineRequired="0" data-inlinePlaceholder=""></td>
	
					<td data-inlineType="doneButton" class="buttonTD">
						<input type="button" value="Edit" onclick="inlineEdit('row_zip', defaultOptions)"/>
					</td>
				</tr>






				<tr id="row_radius">
					<TD class="labelTD">Search Miles: </TD>
					<td 
						id="td_radius"
						data-inlineType="select" data-inlineName="radius"
						data-inlineOptionsTitle='["5","10","20","50","100","500", "1000"]'
						data-inlineOptionsValue='["5","10","20","50","100","500", "1000"]'></td>
				
					<td data-inlineType="doneButton" class="buttonTD">
						<input type="button" value="Edit" onclick="inlineEdit('row_radius', sampleOptions)"/>
					</td>
				</tr>




				<tr>
					
					
					<TD  class="labelTD" style="border:none;vertical-align:top">Trades: </TD>
					
					<td id="trades_table">

						<BR>

						<b style="color:green">&nbsp;&nbsp;* Maximum <a id="maxTrades"></a> Trade Subscriptions Allowed</b>
						
						<P style="height:12px">

						<template id="template_each_trade">
							<span class="each_trade" style="display:inline-block;padding-right:4px">
								<button class="trade_radio" 
								style="transform:translate(2px, 3px);"></button>
								<label></label><sup></sup>
								
							</span>
						</template>       
					
					</td>		

					<td style="width:20%;border:none"></td>
				</tr>
			</table>	


			<BR>
</div>


<!--
  -- BUTTONS
  --
 -->
			<!-- SAVE CHANGES BUTTON -->
			<button id="saveButton" class="button save_button" value="save" style="opacity:0.5" onclick="saveChanges()">Save Changes</button>
			

			<!-- DELETE ACCOUNT BUTTON -->
			<button id="delAccount" class="button del_button" value="delete" style="opacity:1" onclick="deleteAccount()">Delete Account</button>
			
	

			<BR>
			<BR>
				


</section>

				




  <!-- 
    -- ERROR MODAL 
    -- 
    -->
  <div class="row modal" id="error_modal">
    <center><img id="error_logo" src="img/logo_2.png"></center> 
    <h1></h1>
    <a id="error_modal_close" href="javascript:errorModalClose();" href="">X</a>
  </div>


  

	</body>


	<script type="module">
			

		import { inlineEmailFinishCell, inlineURLFinishCell } from "./js/inline-edit.js";
		import { inlineEdit } from "./js/inline-edit.js";
		import { clearCurrentLeed } from "./js/leed.js";
		import { isSubscribed, saveUserChanges, getCurrentUser, deleteCurrentUser } from "./js/user.js";
		import { printError, errorModal, throwError } from "./js/error.js";
		import { USERNAME_URL_PARAM } from "./js/dbTools.js";
		import { turnTrade_On, turnTrade_Off, getAllTrades, createTradesAndColors } from "./js/trades.js";

		import { MAX_USER_SUBS } from "./js/user.js";

		const URL_USER_DELETED = "./user_deleted.html";

		var EDITING = false;

		const CURRENT_USER = getCurrentUser( true );

		if (CURRENT_USER == null || CURRENT_USER.un == null) {
			printError("User Edit", "No user currently logged in");
			errorModal("Cannot Edit User<BR>Not currently logged in.", true);
			throwError("User Edit", "Not logged in");
		}	


		const USER_CHANGES = CURRENT_USER;



		// INITIALIZE UI
		//
		var element = document.getElementById("td_username");
		element.innerHTML = CURRENT_USER.un;


		if (CURRENT_USER.em != null) {
			element = document.getElementById("td_email");
			element.innerHTML = CURRENT_USER.em;
		}

		if (CURRENT_USER.ws != null) {
			element = document.getElementById("td_website");
			element.innerHTML = CURRENT_USER.ws;
		}


		if (CURRENT_USER.ab != null) {
			element = document.getElementById("td_about");
			element.innerHTML = CURRENT_USER.ab;
		}

		if (CURRENT_USER.zp != null) {
			element = document.getElementById("td_zip");
			element.innerHTML = CURRENT_USER.zp;
		}

		if (CURRENT_USER.zr != null) {
			element = document.getElementById("td_radius");
			element.innerHTML = CURRENT_USER.zr
		}


		element = document.getElementById("maxTrades");		
		element.innerHTML = MAX_USER_SUBS;
		// INIT TRADES
		initTrades( tradeListener );








/**
 * Change to a wait cursor
 */
 function waitCursor() {
    document.body.style.cursor = 'wait';
}

/**
 * Change back to normal cursor
 */
function normalCursor() {
    document.body.style.cursor = 'default';
}





		
/**
 * 
 * 
 */
async function initTrades( listener ) {


	if (listener === undefined)
	  listener = this.tradeListener;
  
	let trades = [];
  
	waitCursor();

	try {
	  await getAllTrades().then((response) => trades = response ); 
  
		if (trades == null) {
		  throw new Error("server returned null trades.");
		}
  
		if (trades.length == undefined || trades.length == 0) {
		  throw new Error("server returned empty (0) trades.");
		}



		// init TRADES struct
		// initialize the spectrum of colors
		createTradesAndColors( trades );  
		


		initTradesTable( trades, listener );
  
	  } catch (error) {
		
		// DO NOT FAIL -- show error modal dialog and print error to console
		var msg = "Cannot load trades.<BR>Please refresh page."
		msg = error.message + "<BR>" + msg;
		
		printError("Init Trades Column", error);
		errorModal( msg , true );
	
	} finally {
		normalCursor();
	}
  }


	




  


/**
 *
 * all_trades is the array 
 * 
 * ONLY display the trades to which the user is subscribed
 * [
 * {
   tn: "caricatures",
   nl: 5
 * }, .... 
 * ]
*/
function initTradesTable( all_trades, tradeListener ) {

	if ((all_trades == null) || (all_trades.length == 0)) return;
  
  
	// import DOM elements from html
	const theList = document.querySelector("#trades_table");
	const subs = [];
	const theTemplate = document.querySelector("#template_each_trade");


	all_trades.forEach((trade) => {

	  // clone a new node
	  const newNode = theTemplate.content.cloneNode(true).querySelector(".each_trade");
	
	  // set the label
	  let theLabel = newNode.querySelector("label");
	  theLabel.textContent = trade.sk;

	  // set the leed count as a superscript
	  // if there is an error we are using default leedz without numbers
	  if (trade.nl != undefined)
		newNode.querySelector("sup").textContent = trade.nl;
  
	  let radioButton = newNode.querySelector(".trade_radio");
   
	  // check SUBSCRIPTIONS
	  // is the user subscribed to this trade?
	

	  if ( isSubscribed( trade.sk ) ) {
		turnTrade_On(null, radioButton, theLabel, trade.sk);
	  }

	  
	  //
	  // RADIO BUTTON CLICK LISTENER
	  //
	  radioButton.addEventListener("click", function( event ) {
	
		tradeListener( trade.sk, radioButton, theLabel );
  
	  });
  

  
	  //
	  // LABEL CLICK LISTENER
	  //
	  theLabel.addEventListener("click", function( event ) {
  
		tradeListener( trade.sk, radioButton, theLabel );
		
	  });
  

	  theList.appendChild( newNode );
	});

}

  


  


			

	
  





	/**
	* Helper function
	* 
	* 
	*/
	function tradeListener(trade, radioButton, theLabel) {
		

		try {

		   if ( isSubscribed(trade)  ) { // TRADE is ON
			
				turnTrade_Off(null, radioButton, theLabel, trade);
				USER_CHANGES.sb = USER_CHANGES.sb.filter(function (sub) {
					return sub != trade;
				});
				
				beginEditing();
				
		   } else { // TRADE is OFF

				if (USER_CHANGES.sb.length >= MAX_USER_SUBS) {
					
					printError("Trades Table", "Maximum " + MAX_USER_SUBS + " trade subscriptions allowed");
					return;
				}
				turnTrade_On(null, radioButton, theLabel, trade );
				USER_CHANGES.sb.push(trade);
				
				beginEditing();
		   }
	 
		   
	   } catch (error) {
		 errorModal(error, false);
		 return false;
	   }
		

	}
	window.tradeListener = tradeListener;
	




		/**
		 *
		 */
		function backButton() {
			const CURRENT_USER = getCurrentUser(true);
	
			let href="./index.html?" + USERNAME_URL_PARAM + "=" + CURRENT_USER.un;
			window.open(href, "_self");

			self.close();

		}
		window.backButton = backButton;




		function defaultCallback(rowData, rowName) {

			beginEditing();

			switch(rowName) {

				case "row_username":
					USER_CHANGES.un = rowData["username"];
					break;

				case "row_zip":
					USER_CHANGES.zp = rowData["zip"];
					break;

				case "row_about":
					USER_CHANGES.ab = rowData["about"];
					break;

				case "row_website":
					USER_CHANGES.ws = rowData["ws"];
					break; 
					
				case "row_email":
					USER_CHANGES.em = rowData["em"];
					break; 


				default:
					printError("defaultCallback()", "received unknown form field: " + rowName);
					break;

			}

			// console.log(USER_CHANGES);

		}




	
		function selectCallback(rowData, rowName) {

			beginEditing();

			switch ( rowName ) {

				case "row_radius":
					const theData = rowData["_radiusValue"];
					USER_CHANGES.zr = theData;
					break;

				default:
					printError("defaultCallback()", "received unknown form field: " + rowName);
					break;
			}


			// console.log(USER_CHANGES);
		}





		//
		//
		//
		function beginEditing() {
			var element = document.getElementById("saveButton");
			element.innerHTML = "Save Changes";
			element.style.backgroundColor = "var(--LEEDZ_GREEN)";
			element.style.opacity = 1;

			EDITING = true;
		}


		//
		//
		//
		function endEditing() {
			var element = document.getElementById("saveButton");
			element.innerHTML = "Saved!";
			element.style.backgroundColor = "darkorange";
			element.style.opacity = 0.5;

			EDITING = false;
		}



		/**
		 * EDIT the current user account and save changes to DB
		 */
		function saveChanges() {

			if (! EDITING) return;


			try {
				saveUserChanges( USER_CHANGES );		
		

			} catch ( error ) {

				printError("saveChanges", error);
          		errorModal("Cannot edit user account: " + error.message, false);

			} finally {
				endEditing();
				
				// FIXME FIXME FIXME
				// reload page with new guest account
				// backButton();
			}	
		
		}




		/**
		 * DELETE the current user account and reload the page in Guest user mode
		 */
		function deleteAccount() {

			try {
				// will throw error if guest user
				deleteCurrentUser();			
		

			} catch ( error ) {

				printError("deleteAccount", error);
          		errorModal("Cannot delete user account: " + error.message, false);

			} finally {
				endEditing();
			}	
		
			
				
				//
				// GOTO landing page
				//
				window.open( URL_USER_DELETED , "_self");

		}




		var defaultOptions = { "finishCallback": defaultCallback };

		var emailOptions = {    "finishCallback": defaultCallback,
								"emailFinish": inlineEmailFinishCell };

		var urlOptions = {		"finishCallback": defaultCallback,
								"urlFinish": inlineURLFinishCell };

		var sampleOptions = { "finishCallback": selectCallback };	


		window.inlineEdit = inlineEdit;
		window.defaultOptions = defaultOptions;
		window.emailOptions = emailOptions;
		window.urlOptions = urlOptions;
		window.sampleOptions = sampleOptions;

		window.saveChanges = saveChanges;



	
	
	</script>

	
		


</html>