
<!--
--
-- SHOW the user profile of another user
--    
-->   
<!DOCTYPE html>
<html lang="en">
	
	<head>
		 <meta charset="UTF-8">
		 <meta name="viewport" content="width=device-width, initial-scale=1.0">
	 
		 <TITLE>LEEDZ Show User</TITLE>
	 
	 	<!-- Favicon -->
		 <link rel="shortcut icon" type="image/png" href="./img/favicon.png"> 
		 <link rel="icon" type="image/x-icon" href="./img/favicon.ico">
 
		 <link rel="stylesheet" href="./css/user_edit.css" tyep="text/css"/>

		 <link rel="stylesheet" href="./css/globals.css" type="text/css" />
		 <link rel="stylesheet" href="./css/trades.css" type="text/css" />
         <link rel="stylesheet" href="./css/modal.css" type="text/css" />

		 <script src="./js/inline-edit.js" type="module" defer></script> 
		 <script src="./js/trades.js" type="module" defer></script>
		 <script src="./js/error.js" type="module" defer></script>
		 <script src="./js/dbTools.js" type="module" defer></script>
	</head>


		 
	<center>


	<body>
	


			
        <div class="row" style="width:95vw;vertical-align:bottom;border-bottom: 2px solid var(--LEEDZ_DARKGREEN);">

			<div class="column _1">

				<a onclick="backButton()"><button class="back_button" style="margin:35px 20px; width:50px">&#10140;</button></a>
				</div>

				<div class="column" style="margin:auto 0;transform:translateY(6px)">
					<h1 class="user_title">Leedz User</h1>
				</div>
				
				<div class="column _3" style="padding:6px;text-align:center">
				<img src="./img/logo_2.png" style="width:120px">
				</div>
			
			
		
			</div>



<section>

    <BR>	


            
<div class="row" id="form_container">

            <table cellspacing="5vw">
					
				
                <tr id="row_username">
                
                    <TD class="labelTD">Username: </TD>
                    
                    <td colspan=2 id="td_username" data-inlineType="text" data-inlineName="username" 
                    data-inlineRequired="true" data-inlinePlaceholder="(Required)" style="color:green;font-weight:600;font-size:1.5em;"></td>
    
                    
                </tr>


                


				<tr id="row_subs">

					<TD class="labelTD">Trades: </TD>
					
					<td colspan=2 id="td_subs" data-inlineType="textarea" data-inlineName="subs">
                        
						<template id="template_each_trade">
							<span class="each_trade" style="display:inline-block;padding-right:4px">
								<button class="trade_radio" 
								style="transform:translate(2px, 3px);"></button>
								<label></label><sup></sup>
								
							</span>
						</template>
                    </td>
					
                </tr>





				<tr id="row_badges">

					<TD class="labelTD">Badges: </TD>
					
					<td colspan=2 id="td_badges" data-inlineType="textarea" data-inlineName="badges"></td>
					
                </tr>



				<tr id="row_about">

					<TD class="labelTD">About: </TD>
					
		
					<td colspan=2 id="td_about" data-inlineType="textarea" data-inlineName="about">Help sell the leedz you post</td>
					
				</tr>




				<tr id="row_website">
					
					<TD class="labelTD">Website: </TD>
					
					<td colspan=2 id="td_website" data-inlineType="link" data-inlineName="website" data-inlineRequired="0" data-inlinePlaceholder="(Website)"></td>
	
				</tr>



				<tr id="row_email">
					
					<TD class="labelTD">Email: </TD>
					
					<td colspan=2 id="td_email" data-inlineType="email" data-inlineName="email" data-inlineRequired="true" data-inlinePlaceholder="(Required)"></td>
	
		
				</tr>


			</table>	
        </div>

        <BR>
    </div>			

</section>



  <!-- 
    -- ERROR MODAL 
    -- 
    -->
  <div class="row modal" id="error_modal">
    <center><img id="error_logo" src="img/logo_2.png"></center> 
    <h1></h1>
    <a id="error_modal_close" href="javascript:errorModalClose();" href="">X</a>
  </div>



  

	</body>

    <script src="./js/badges.js">
    </script>


	<script type="module">
			

		import { blankUserObject, getCurrentUser } from "./js/user.js";
		import { printError, throwError } from "./js/error.js";
		import { getTradeInfo } from "./js/trades.js";
		import { db_getUser, USERNAME_URL_PARAM } from "./js/dbTools.js";
        import { ALL_BADGES } from "./js/badges.js";



        
        window.ALL_BADGES = ALL_BADGES;

        const urlParams = new URLSearchParams(window.location.search);
        const url_username = urlParams.get( USERNAME_URL_PARAM );

        var element = null;


        // top of page
        // HEADER
        // element = document.querySelector(".user_title");
        // element.innerHTML = url_username;


        const SHOW_USER = blankUserObject();

        let success = null;
        try {

            await showUser( url_username ).then((response) => success = response);

        } catch (error) {
            const msg = "Cannot show user profile for:<BR>" + url_username + "<BR>" + error.message;
            errorModal(msg, true);
            
        }


        if (success) {
            if (SHOW_USER.un != null) {
                element = document.getElementById("td_username");
                element.innerHTML = SHOW_USER.un;
            }

            if (SHOW_USER.em != null) {
                element = document.getElementById("td_email");
                element.innerHTML = SHOW_USER.em;
            }

            if (SHOW_USER.ws != null) {
                element = document.getElementById("td_website");
                element.innerHTML = SHOW_USER.ws;
            }


            if (SHOW_USER.ab != null) {
                element = document.getElementById("td_about");
                element.innerHTML = SHOW_USER.ab;
            }


            //
            // TRADES SUBSCRIBED
            //
            if (SHOW_USER.sb != null) {
                element = document.getElementById("td_subs");
                showUserTrades(element, SHOW_USER.sb);
            }


            //
            // BADGES
            //
            if (SHOW_USER.bg != null) {
                element = document.getElementById("td_badges");
                showUserBadges(element, SHOW_USER.bg);
            }



            
        }

/**
 *
 *
 */
 function showUserTrades( element, subs ) {

	const theTemplate = document.querySelector("#template_each_trade");

    for (let i = 0; i < subs.length; i++) {
        // the_subs = the_subs + subs[ i ] + ",";

        // clone a new node
        var newNode = theTemplate.content.cloneNode(true).querySelector(".each_trade");
        
        // set the label
        var theLabel = newNode.querySelector("label");
        theLabel.textContent = subs[i];

        // get the color and num_leedz
        var trade_info = getTradeInfo( subs[i] );

        // set the leed count as a superscript
        // if there is an error we are using default leedz without numbers
        newNode.querySelector("sup").textContent = trade_info[1];
    
        var radioButton = newNode.querySelector(".trade_radio");
        radioButton.style.backgroundColor = trade_info[0];
        radioButton.style.cursor = "default";
 
        element.appendChild(newNode);
    }
    
 }



/**
 *
 *
 */
function showUserBadges( element, badges ) {
       
    

    if (badges.length == 0) return;
    
        
    let the_html = "<table id='badges_list'>";

    for (let i = 0; i < badges.length; i++) {

        the_html += "<TR><td class='badge_icon'><img src='" + ALL_BADGES[i].url + "'></td><td><B>" + ALL_BADGES[i].tit + "</B><BR>" + ALL_BADGES[i].cap + "</td></TR>";
            
    }
    
    
    the_html += "</table>";

    element.innerHTML = the_html;
}






/**
 *
 *
 */
 async function showUser( username ) {

    //   client <---> API Gateway <===> DB
    //
    // GET the user JSON data from the server
    // UPDATE SHOW_USER with new values from DB
    //
    let resObj = [];   
    try {
    // get the user object
        await db_getUser( username )
        .then(data => {
    
            if (data == null) throw new Error("null response from GET");
            
            resObj = data;
            
    
        })
        .catch(error => {
            let msg =  "Error initializing user [ " + username + " ]: " + error.message;
            printError("db_getUser", msg);
            throwError('Init User', error);
            return false;
        });


        console.log("GOT USER DATA!");
        console.log( resObj );


        // copy the new values into SHOW_USER

        // some fields are mandatory and will always contain values
        // some are optional and may be null
        // if statements are in case cache version is more recent
        // 
        SHOW_USER.un = resObj.sk;
        SHOW_USER.em = resObj.em;

        SHOW_USER.ws = resObj.ws;
        SHOW_USER.ab = resObj.ab;

        // TRADES
        SHOW_USER.sb =  (resObj) ? resObj.sb.split(',').map(element=>element.trim()) : [];

        // USER BADGES
        SHOW_USER.bg = (resObj) ? resObj.bg.split(',').map(element=>element.trim()) : [];
           
    
    } catch (error) {

        printError( "db_getUser", error.message );
        throwError( "initShowUser", error); 
        return false;
    }

    return true;
}
       
   





         

		/**
		 *
		 */
		function backButton() {
			const CURRENT_USER = getCurrentUser(true);
	
			let href="./index.html?" + USERNAME_URL_PARAM + "=" + CURRENT_USER.un;
			window.open(href, "_self");

			self.close();

        }
		window.backButton = backButton;







	
	</script>

	
		


</html>